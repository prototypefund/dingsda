<!DOCTYPE html>
<html lang="en">
  <!-- fdff -->
<head>
  <meta charset="utf-8">
  <title>dingsda user interface 2</title>

  <!-- atm out because media stream issues in ios standalone mode in barcode scanners-->
  <!-- <meta name="apple-mobile-web-app-capable" content="yes" /> -->

  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/jquery.mobile-1.4.5.min.css">

  <!-- only for debug with phonegap/cordova -->
  <!--<script src="http://192.168.178.128:8080/target/target-script-min.js#anonymous"></script>-->
  <!-- ONLY IF PACKED WITH PHONEGAP / CORDOVA: -->

  <!--
  <script src="cordova.js"></script>
  -->
  <!-- for 3rd party barcode lookup via phonegap -->
  <!--
  <script src="assets/barcodeCheck.js"></script>
  -->

  <!--<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="assets/jquery.mobile-1.4.5.min.js"></script>
  <script src="assets/sweetalert2.js"></script>
  <script src="assets/bootstrap-tagsinput.js"></script>
  <script src="assets/jquery.easy-autocomplete.min.js"></script>
  <!-- https://github.com/tuupola/jquery_lazyload/tree/2.x -->
  <script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-beta.2/lazyload.js"></script>

  <link rel="stylesheet" href="assets/easy-autocomplete.min.css">

  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <link rel="stylesheet" type="text/css" href="assets/bootstrap-tagsinput.css" />
  <!--<link rel="stylesheet" href="nativedroid2/css/nativedroid2.css">-->
  <!-- MAPSCRIPT HEADER PARTS  -->

  <script type="text/javascript" src='https://maps.google.com/maps/api/js?key=AIzaSyAh_E5RUWU_48EPbSCkfIzwydNk1UEwZsQ&libraries=places'></script>
  <!-- includes jquery plugin to use key -->
  <script src="assets/locationpicker.jquery.js"></script>

  <!--  END MAPSCRIPT HEADER PARTS  -->

  <!-- CARNET ATA EXPORT PARTS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.4.0/jspdf.debug.js"></script>
  <script src="assets/carnet.js"></script>
  <!-- END CARNET ATA EXPORT PARTS-->

  <!-- BARCODE dependency -->
  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
  <!-- END BARCODE dependency -->

</head>

  <body class="ui-mobile-viewport ui-overlay-a">

     <img id="loadingGif" src="assets/images/ajax-loader.gif" alt="ladeanimation"></img>

<style>
  .landing-content{
    padding:0;
    overflow: hidden
  }

  .landing-content #btn_collection{
    background-color: #abcecc !important;
  }

  .landing-content #btn_searchpage{
    background-color: #fff2cd !important;
  }

  .landing-content a[href="#addNew"]{
    background-color: #ff004c !important;
    color: #fff2cd !important;
  }

</style>

<div data-role="page" id="landing">


  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content landing-content">

      <a class="ui-btn btn_3rd" href="#addNew" onclick="clearForm();">
        <span>ADD NEW ITEMS</span>
      </a>

      <a class="ui-btn btn_3rd" id="btn_searchpage" href="#search" onclick="btn_searchpage_clicked()">
        <span>THINGS<br>OTHER PEOPLE<br>SHARE</span>
      </a>

      <a class="ui-btn btn_3rd" id="btn_collection" class="btn_collection" href="#collection" onclick="btn_collection_clicked()">
        <span>MY COLLECTION</span>
      </a>

      <a class="ui-btn btn_3rd" id="btn_table" class="btn_table" href="#table">
        <span>TABLEVIEW (ALPHA VERSION)</span>
      </a>

  </div>
  <!-- END CONTENT -->

 <!--<div data-role="page" id="maps">
    <div id="locationMoveable" class="collapsible_right" data-role="collapsible"
      data-mini="true" data-iconpos="right" data-collapsed-icon="location">
      <h3 id="location_collapsible">
        location: <span class="locationdescription"></span></h3>

      <div id="containerOf" class="containerOf" data-role="collapsible" data-mini="true" data-collapsed-icon="bullets" data-expanded-icon="arrow-u" data-collapsed="true">
      <h6>contains:</h6>
      <span class="mediumfont" id="other.containerOf"></span>
      </div>

      <div class="locationContainer">
        <div class="map_description_container">
          <input type="text" class="form-control map_value map_description" id="description"
                placeholder="description/name of place"/>
        </div>

        <input type="text" class="form-control map_value" id="address"
            placeholder="address"/>

        <button id="getLocation" data-role="button" data-icon="location"
          data-iconpos="right" data-inline="true" class="btn_getlocation">set</button>
        <div id="map"></div>

        <div class="geodataContainer" id="geodataContainer">

          <table class="geotable">
            <tr><td>
              latitude:
            </td></tr>
            <tr><td>
              <input type="text" class="form-control map_value" id="latitude"/>
            </td></tr>
          </table>
          <table class="geotable">
            <tr><td>
              longitude:
              </td></tr>
              <tr><td>
                <input type="text" class="form-control map_value" id="longitude"/>
              </td></tr>
          </table>
        </div>

    </div>

      <div id="insideOfContainer" hidden>
        insideOf: <a id="insideOf_name" class="mediumfont"></a>
        <input type="text" class="form-control map_value"
        placeholder="id of container" id="insideOf"/>
      </div>


      <input type="checkbox" data-role="flipswitch" name="flip-location"
       id="fliplocation" data-off-text="not inside other thing"
       data-on-text="inside other thing"
       data-wrapper-class="custom-size-flipswitch"></input>

    </div>
</div>
-->


</div>


<script>


$( document ).on( "pageshow", "#landing", function(e,ui) {

    console.log("just loaded landing");

})

function btn_collection_clicked(reload=false){

  let lastSearchWasForUserDB = (collection.searchDB === glb_username && !collection.reloadOnNextClick);

  if(collection)
  {
    console.log("collection clicked. username will be target");
    collection.searchQuery = {"_id":{"$regex":""}};
    collection.searchDB = glb_username;
  }
  if(reload)
  {
    $.mobile.changePage("#collection", {
       reloadPage: false
   });

 }
 // if most recent search was for userDB, just render again but dont get from server
 if (lastSearchWasForUserDB && $("#itemList li").length>0)
 {
  console.log("last search was for userdb. so wont fetch and wont draw");

  refreshCollection(console.log,false,false);

  collection.reloadOnNextClick = false
 }
 else // if last search was to a public or this is the first search: fetch and then render
 {
  refreshCollection(console.log,true,true);
  collection.reloadOnNextClick = false
 }

}

/**
fetches the user's collection from DB and makes it render
*/
function refreshCollection(callback=console.log,draw=true, fetchDataFromServer=false){
  //$("#loadingGif").show();
  setTimeout(function(){
    if (fetchDataFromServer)
    {
      $("#loadingGif").show();
      $("#itemList .item").parent().remove();
      /*
      searchAndDoStepsInBetweenPages(glb_username,{_id:""},
        (r)=>{ // callback each loop
          if (draw){
            drawItemCards(r.docs)
          }
        },
        (r)=>{  // callback end
          setNewCollectionSearchHistory(r);
          $("#loadingGif").hide();
          callback(r.docs);
        }
      )*/
      searchAndShow(0,0,0,callback,glb_username); // new SearchAPI
      /*
      searchDB(collection.searchDB,collection.searchquery,function(inp){

        setNewCollectionSearchHistory(inp.docs)

        if(draw){
          drawItemCards(inp.docs);
        }
        callback(inp.docs);
      });*/
    }
    else
    {
      if (draw)
      {
        $("#itemList .item").parent().remove();
        drawItemCards(collection.searchhistory[0])
      }
      callback(true)
    }

  },100)

}

function getItemsInMyPossession(forceRender=false){

// get inMyPossession via API:
  let query = {"data":[{"type":"getInMyPossession"}]}
  $.ajax({
    type: "POST",
    url: API_BASE_URL+glb_username,
    data: JSON.stringify(query),
    success: function(inMyPossession){

      /*
      add every item references by docs inside of inMyPossession
      to the itemlist in collection view:
      */
      console.log(inMyPossession);
      for (item of inMyPossession)
      {
        console.log("CATCHING ITEMS");
        getSingleItem(item._id,function(object){
          // if already in searchhistory: don't draw again else: draw and update!
           let itemAlreadyInSearchhistory = collection.searchhistory[0].find((o,i)=>{
            return o.hyperlink === object.hyperlink
          })
          if (forceRender || itemAlreadyInSearchhistory === undefined)
          {
            let card = makeItemCard(object);
            $("#itemList").prepend(card);
            addItemCardClickListener();
            if (!itemAlreadyInSearchhistory)
            {
              collection.searchhistory[0].push(object);
            }
            $("#itemList").listview('refresh');
            lazyload(); // init lazy load of images (see head.mustache)
            window.scrollTo(0, 0);
          }

        })
      }


    },
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: console.log,
    contentType:"application/json"
  })
  /*
  getSingleItem("&inMyPossession",function(inMyPossesion){
    //updateBorrowItemsBatch(inMyPossesion.things.length)
    for (item of inMyPossesion.things)
    {
      getSingleItem(item,function(object){
        // if already in searchhistory: don't draw again else: draw and update!
         let itemAlreadyInSearchhistory = collection.searchhistory[0].find((o,i)=>{
          return o.hyperlink === item
        })
        if (forceRender || !itemAlreadyInSearchhistory)
        {
          let card = makeItemCard(object);
          $("#itemList").prepend(card);
          addItemCardClickListener();
          if (!itemAlreadyInSearchhistory)
          {
            collection.searchhistory[0].push(object);
          }
          $("#itemList").listview('refresh');
          lazyload(); // init lazy load (see head.mustache)
          window.scrollTo(0, 0);
        }

      })
    }
  })
  */
}

function btn_searchpage_clicked()
{


/*
if(collection)
  {
    console.log("searchpage clicked. public is target");
    collection.searchQuery = {_id:""};
    collection.searchDB = "public";

    $("#loadingGif").show();
    $("#itemList .item").parent().remove();
    //searchDB(collection.searchDB,collection.searchquery,drawItemCards);
    searchAndDoStepsInBetweenPages(collection.searchDB,collection.searchquery,
      (r)=>{ // callback each loop
          drawItemCards(r.docs)
      },
      (r)=>{  // callback end
        setNewCollectionSearchHistory(r);
      }
    )

  }
*/
}

</script>

<div data-role="page" id="maps">
    <div id="locationMoveable" class="collapsible_right" data-role="collapsible"
      data-mini="true" data-iconpos="right" data-collapsed-icon="location">
      <h3 id="location_collapsible">
        location: <span class="locationdescription"></span></h3>

      <div id="containerOf" class="containerOf" data-role="collapsible" data-mini="true" data-collapsed-icon="bullets" data-expanded-icon="arrow-u" data-collapsed="true">
      <h6>contains:</h6>
      <span class="mediumfont" id="other.containerOf"></span>
      </div>

      <div class="locationContainer">
        <div class="map_description_container">
          <input type="text" class="form-control map_value map_description" id="description"
                placeholder="description/name of place"/>
        </div>

        <input type="text" class="form-control map_value" id="address"
            placeholder="address"/>

        <button id="getLocation" data-role="button" data-icon="location"
          data-iconpos="right" data-inline="true" class="btn_getlocation">set</button>
        <div id="map"></div>

        <div class="geodataContainer" id="geodataContainer">

          <table class="geotable">
            <tr><td>
              latitude:
            </td></tr>
            <tr><td>
              <input type="text" class="form-control map_value" id="latitude"/>
            </td></tr>
          </table>
          <table class="geotable">
            <tr><td>
              longitude:
              </td></tr>
              <tr><td>
                <input type="text" class="form-control map_value" id="longitude"/>
              </td></tr>
          </table>
        </div>

    </div>

      <div id="insideOfContainer" hidden>
        insideOf: <a id="insideOf_name" class="mediumfont"></a>
        <input type="text" class="form-control map_value"
        placeholder="id of container" id="insideOf"/>
      </div>


      <input type="checkbox" data-role="flipswitch" name="flip-location"
       id="fliplocation" data-off-text="not inside other thing"
       data-on-text="inside other thing"
       data-wrapper-class="custom-size-flipswitch"></input>

    </div>
</div>

<style>

  #config {
    background-color: #fff2cd;
  }

  #logout{
    background-color: #ff004c !important;
    color: #fff2cd !important;
    text-shadow: none;
  }

  #btn_upd_contact_info {
    background-color: #abcecc;
    text-shadow: none;
  }

</style>

<div data-role="page" id="config">

  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content">

      <button id="logout" style="margin-top:0">logout</button>
      <h1 align="center">config</h1>
      <br>

      <h3 align="center">your contact information:</h3>
      <input id="contact_email" type="email" placeholder="your email" value="" />
      <input id="contact_telnumber" type="number" placeholder="your phone number" value="" />
      <input id="contact_other" type="text" placeholder="other way to contact you" value="" />
      <br>
      <button id="btn_upd_contact_info">save</button>

  </div>
  <!-- END CONTENT -->

</div>

<script>

  let config = {
    _id: "&config",
    contact_details: {}
  }

  $( document ).on("pageshow", "#config", function(e,ui) {
    fetchConfig();
  })

  function fetchConfig(){
    getSingleItem("&config",function(res){
      if (res._id){
        console.log(res);
        config = res;

        // fillconfigForm:
        $("#contact_email").val(config.contact_details.email);
        $("#contact_telnumber").val(config.contact_details.telnumber);
        $("#contact_other").val(config.contact_details.other);
      }
    })
  }

  function logout(){
    // delete AuthSession Cookie (will only work if cookie from same URL)
    $.ajax({
        type: "DELETE",
        url: API_BASE_URL,
        xhrFields: { withCredentials: true }, // to make AuthCookie ok
        success: function(res)
          {
            console.log(res);
            showToast(res,500);
            // reload page();
            window.location.href = UI_URL;
          },
        error: function(err){
          console.log(err);
        },
        contentType:"application/json"
      });
  }

  $("#logout").click(function(){
    logout();
  })


  $("#btn_upd_contact_info").click(function(){

    config.contact_details.email = $("#contact_email").val();
    config.contact_details.telnumber = $("#contact_telnumber").val();
    config.contact_details.other = $("#contact_other").val();

    updateit(config,function(res){
      console.log(res);
      if(res.ok == true)
      {
        swal({text:"SAVED SUCCESSFULLY", toast:true, timer:1200,
          showConfirmButton:false, position:"center",customClass:"whiteletters"
        }).then(function(){});
      }
      else {
        swal({title:"UPDATE ERROR",text:res.statusText, toast:true,customClass:"whiteletters"});
        console.log(res);
      }
    })


  })

</script>

<div data-role="page" id="notifications">


  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content">
      <p><b>notifications</b></p>
      <ul data-role="listview" data-split-icon="gear" data-split-theme="d"></ul>
  </div>
  <!-- END CONTENT -->

</div>


<script>

$( document ).on( "pageshow", "#notifications", function(e,ui) {
    console.log(window.location.search);
    console.log("just loaded notifications");
    console.log(ui.prevPage);

    console.log("fetching notifications from DB");

    $("#notifications .ui-content ul").html("");
    getNotificationsFlat(function(res){
      for(value of res)
      {
        console.log(value);
        addNotification(value);
      }
    })

})

function showNotifications(){
  $.mobile.pageContainer.pagecontainer("change", "#notifications",
             {allowSamePageTransition:true/*,transition: "slidefade"*/});
  updateNotificationsBatch();
}

function removeNotification(notification,e)
{
  console.log("deleting simple notification"+notification.ref);
  $(e.srcElement).parent().parent().remove(); // remove notification div

  let query = {"data":[{"type":"deleteNotification","_id":notification}]}
  $.ajax({
    type: "POST",
    url: API_BASE_URL+glb_username,
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    data: JSON.stringify(query),
    contentType:"application/json",
    success: function(res){
      console.log(res);
      updateNotificationsBatch();
      updateBorrowItemsBatch();
      //refreshCollection(console.log,true,true);
    }
  })
}

function cancelHandover(notification,e)
{
  console.log("canceling pending handover"+notification.ref);
  $(e.srcElement).parent().parent().remove(); // remove notification div
  // send to users DB API: handover confirmation
  let dataOut = {
    "data":
          [{
            "type":"handover_cancel",
            "ref":notification.ref,
            "to":notification.to,
          }]
  }
  $.ajax({
    type: "POST",
    url: API_BASE_URL+glb_username,
    data: JSON.stringify(dataOut),
    success: function(r){
      updateNotificationsBatch();
      //showNotifications();
      console.log(r)
    },
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: console.log,
    contentType:"application/json"
  });
}

function confirmHandover(notification, confirmed, e)
{
  console.log(notification);
  if (confirmed)
  {
    console.log("confirming handover of "+notification.ref);
    $(e.srcElement).parent().parent().remove(); // remove notification div
    // send to users DB API: handover confirmation
    let dataOut = {
      "data":
            [{
              "type":"handover",
              "ref":notification.ref,
              "from":notification.from
            }]
    }
    $.ajax({
      type: "POST",
      url: API_BASE_URL+glb_username,
      data: JSON.stringify(dataOut),
      success: function(r){
        //showNotifications();
        updateNotificationsBatch();
        updateBorrowItemsBatch();
        refreshCollection(console.log,true,true);
        getItemsInMyPossession();
        console.log(r)
      },
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      error: console.log,
      contentType:"application/json"
    });
  }
  else {
    console.log("denying handover of "+notification.ref);
    $(e.srcElement).parent().parent().remove(); // remove notification div
    let dataOut = {
      "data":
            [{
              "type":"handover_deny",
              "ref":notification.ref,
              "from":notification.from
            }]
    }
    $.ajax({
      type: "POST",
      url: API_BASE_URL+glb_username,
      data: JSON.stringify(dataOut),
      success: function(r){showNotifications();console.log(r)},
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      error: console.log,
      contentType:"application/json"
    });
    // to do: backend: send info notification to lender
  }

}

function addNotification(noti)
{
  let listitem = "";
  switch(noti.type) {
      case "handover_await":
        listitem = makeNotification({
            text:`<br>awaiting handover confirmation from ${noti.to} about ${noti.ref}`,
            cb_cancel:function(e){cancelHandover(noti,e);},
          })
        break;
      case "handover_confirm":
          listitem = makeNotification({
              text:`<br>did you receive ${noti.refname} (${noti.ref}) from ${noti.from}?`,
              wording_cancel:"no",
              wording_confirm:"yes, i did!",
              cb_confirm:function(e){confirmHandover(noti,true,e);},
              cb_cancel:function(e){confirmHandover(noti,false,e);}
            })
        break;
      case "info":
      listitem = makeNotification({
          text:"<br>"+noti.text,
          wording_confirm:"I got it, DELETE!",
          cb_confirm:function(e){removeNotification(noti._id,e);
            updateNotificationsBatch();/*showNotifications()*/}
        })
        break;
      default:
        break;
  }
  $("#notifications .ui-content ul").append(listitem)
  //$("#notifications .ui-content ul").append("<li>"+JSON.stringify(noti) )
}

function makeNotification({text="",cb_confirm=null,cb_cancel=null,
                      wording_confirm="confirm",wording_cancel="cancel"}={})
{

  let notification = document.createElement("li");
  notification.classList.add("ui-btn");
  notification.setAttribute("data-corners",false)
  notification.style.maxWidth = "100vw";
  notification.style.display = "flex";
  notification.style.flexDirection = "column";
  notification.style.justifyContent = "space-between";
  notification.style.backgroundColor = "#fff2cd";

  let notiText = document.createElement("div")
  notiText.style.width = "100%";
  notiText.style.minHeight = "50px";
  notiText.style.whiteSpace = "normal";
  notiText.innerHTML=text;

  notification.appendChild(notiText)

  let buttonContainer = document.createElement("div");
  buttonContainer.style.width = "100%";
  buttonContainer.style.display = "flex";
  buttonContainer.style.flexDirection = "row";
  buttonContainer.style.justifyContent = "space-between";

  notification.appendChild(buttonContainer);

  if (cb_confirm)
  {
    console.log("building confirm button");
    let confirm_btn = document.createElement("div");
    confirm_btn.classList.add("ui-btn");
    confirm_btn.style.width = "100%";
    confirm_btn.style.textShadow = "none";
    confirm_btn.style.backgroundColor = "#abcecc";
    confirm_btn.innerHTML = wording_confirm;
    confirm_btn.addEventListener("click",function(e){cb_confirm(e)})

    buttonContainer.appendChild(confirm_btn)
  }
  if (cb_cancel)
  {
    console.log("building confirm button");
    let cancel_btn = document.createElement("div");
    cancel_btn.classList.add("ui-btn");
    cancel_btn.style.width = "100%";
    cancel_btn.style.textShadow = "none";
    cancel_btn.style.backgroundColor = "#ff004cc7";
    cancel_btn.style.color = "#fff2cd";
    cancel_btn.innerHTML = wording_cancel;
    cancel_btn.addEventListener("click",function(e){cb_cancel(e)})

    buttonContainer.appendChild(cancel_btn)
  }

  return notification
}


function getNotificationsFlat(callback=console.log)
{
  let query = {"data":[{"type":"getNotifications"}]}
  $.ajax({
    type: "POST",
    url: API_BASE_URL+glb_username,
    data: JSON.stringify(query),
    success: function(r){
      console.log(r);
      callback(r);
    },
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: console.log,
    contentType:"application/json"
  });
}

</script>

<div data-role="page" id="collection">
  <style>


  #collection .barcodebtn {
      height: 1.4em;
      bottom: 1vh;
      border: 0px dotted lightgrey;
      position: fixed;
      right: 10vw;
    }


    #collection{
      margin-top: 0px;
    }

    #itemList{
      margin-bottom: 5vh;
    }

    #filterinput {
      width: 90%;
    }

    #filterform {
      width: 100%;
      bottom: 90px;
      position: fixed;
      z-index: 99;
      background-color: white;
      height: 0px;
      font-size: 1.5em
    }

    .ui-listview .ui-li-has-thumb>img, .ui-listview
    .ui-li-has-thumb>.ui-btn>img, .ui-listview .ui-li-has-thumb
    .ui-li-thumb {
      position: absolute;
      left: 0;
      top: 0;
      max-height: 100%;
      max-width: 50%;
      z-index: 1;
    }

    .behindImg {
      background-color: black;
      height: 100%;
      width: 50%;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 0
    }

    .ui-listview>.ui-li-has-thumb>.ui-btn, .ui-listview>.ui-li-static.ui-li-has-thumb {
      height: 7em;
      padding-left: 51%;
      white-space: normal;
      overflow: hidden;
      color: black;
    }

    .ui-listview span{
        font-size: 0.9em;
        display:block;
        color: rgba(225,50,255,0.7);
        line-height: 100% !important;
    }

    .ui-listview i{
      /*color: #abcecc;*/
      color: red;
      font-size: 0.9em;
    }

    .ui-listview b{
      color: black
    }

    .item{
      overflow: scroll;
      overflow: hidden; /*scroll would be cooler.*/
    }

    .chooseOverlay{
      height: 100%;
      width: 100%;
      position: absolute;
      z-index: 50;
      left: 0;
      top: 0;
      background-color: rgba(200, 200, 200, 0.0);
    }

    .itemCheckbox{
      height:2em;
      width: 2em;;
      background-color: rgba(255,255,255,0.7);
      border: 1px black solid;
      left: 5px;
      top: 5px;
      border-radius: 25%;
    }

    .itemChecked span::after {
      content: "\2713";
      font-family: monospace;
      font-size: 2em;
      color: #0000008f;
      margin-left: 0.2em;
      margin-top: 0.2em;
      position: absolute;
    }

    .itemChecked {
      background-color: rgba(0, 0, 0, 0.1);
    }

    .borrowedItem {
      background-color: lightblue !important;
      text-shadow: none !important;
    }

    .borrowedItem::before{
      font-size: 1em;
      font-style: oblique;
      z-index: 99;
      position: absolute;
      color: blue;
      content: "  borrowed  ";
      background: rgba(255,255,255,0.7);
      left: 20px;
      bottom:10px;
      padding: 3px;
    }


    .loanedItem {
      background-color: rgba(220,200,220,0.1) !important;
      text-shadow: none !important;
      opacity: 0.65
    }

    .loanedItem::before{
      font-size: 1em;
      font-style: oblique;
      z-index: 99;
      position: absolute;
      color: #ff004c;
      content: "  lent out  ";
      background: rgba(255,255,255,0.7);
      left: 20px;
      bottom:10px;
      padding: 3px;
    }

    .chooseButtons{
      pointer-events: none;
      position: fixed;
      z-index: 9999;
      top: -7px;
      width: 100%;
      left: 0;
      display: none;
    }

    .btn_bulk_action{
      pointer-events: all;
      height: 3.8em;
      text-shadow: 0px 0px 0px black !important;
      background-color: #ff004c !important;
      color: #fff2cd !important;
      width: 100vw;
      margin: 0;
    }

    .bulk_main_action {
      background-color: #fff2cd !important;
      color: black !important;
    }

    #btn_bulk_handover {
      background-color: #fff2cd !important;
      color: black !important;
    }

    #btn_bulk_move {
      /*width: 100%;*/
    }

    #btn_mark_all{
      pointer-events: all;
      z-index: 33;
      width: 9em;
      font-size: 0.8em;
      padding: 2px;
      bottom: 4em;
      height: 4em;
      background-color: rgba(200,200,200,0.8);
    }

    #btn_endChooseMenu {
      pointer-events: visible;
      float: right;
      width: 4em;
      height: 4em;
      padding: 3px;
      font-size: 0.7em;
      margin-right: 1em;
      background-color: rgba(171, 207, 204,0.8);
    }

    #btn_bulk_carnet_pdf {
      pointer-events: visible;
      bottom: 3em;
      right: 0;
      opacity: 0.8;
      width: 50vw;
      background-color: rgba(0,0,0,0.8);
      color: white;
      text-shadow: none;
    }

    .overfooter{
      bottom: -8px;
      position: fixed;
    }

    .typing {
      white-space: nowrap;
      overflow: hidden;
      animation: typing 2.5s steps(30, end) infinite, blink-caret .75s step-end infinite;
    }

    /* typing effect */
    @keyframes typing {
      from { width: 0 }
      to { width: 100% }
    }

    /* typewriter cursor */
    @keyframes blink-caret {
      from, to { border-color: transparent }
      50% { border-color: orange; }
    }

  </style>

  <!-- HEADER TEMPLATE-->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->
  <div  id="filterform">
      <form class="ui-filterable" id=filterable>
        <input id="filterinput" data-type="search"
          placeholder="Filter by keywords..." aria-label="search input field">
      </form>
      <img class="barcodebtn" src="./icons/barcode.png" onclick="scan('#filterinput')">
  </div>
  <!-- CONTENT -->
  <div role="main" class="ui-content">

    <div class="collectionview">

    <ul id="itemList" data-role="listview" data-filter="true" data-input="#filterinput">

      <div id="no_items_left" style="color:pink">loading ...</li>

    </ul>

    </div>
    <div class="chooseButtons" data-role="button">
      <button id="btn_bulk_delete" class="btn_bulk_action ">DELETE ITEMS</button>
      <button id="btn_endChooseMenu">back</button>
      <button id="btn_mark_all" class="overfooter">(un)check all</button>
      <button id="btn_bulk_carnet_pdf" class="overfooter">Carnet ATA PDF</button>
      <div class="overfooter ui-grid-a" style="width:100%">
        <button id="btn_bulk_handover"
        class="btn_bulk_action ui-block-a">HANDOVER ITEMS</button>
        <button id="btn_bulk_move"
        class="btn_bulk_action bulk_main_action ui-block-b">MOVE ITEMS</button>
      </div>

    </div>


  </div>
  <!-- END CONTENT -->

</div>

<script>

//// collection object is the global object containing all infos that other pages
////  want to handover to collection or collection wants to remember
var collection = {
    searchQuery : {_id:""},
    searchDB : "",
    searchhistory:[],
    chooseMode:false,
    bulk:[],
    bookmark: undefined,
    reloadOnNextClick: false
}

function switchOffButtonListener()
{
  $('#btn_bulk_move').off('click');  // switch off button listener for overlay
  $('#btn_bulk_delete').off('click'); // switch off button listener for overlay
}


$( document ).on( "pageshow", "#collection", function(e,ui) {
    //console.log(window.location.search); console.log(ui.prevPage);
    console.log("just loaded collection");

    $("#btn_mark_all").click(function(){
      $(".chooseOverlay:visible").toggleClass("itemChecked");
    })

    $("#btn_bulk_delete").click(function(){

      getCheckedItems();
      listChooseMode(); // end chooseMode
      switchOffButtonListener()
      deleteItems(collection.bulk);
    })

    $("#btn_bulk_move").click(function(){

      getCheckedItems();
      listChooseMode(); // end chooseMode
      switchOffButtonListener();
      $.mobile.changePage("#move");
    })

    $("#btn_bulk_handover").click(function(){

      getCheckedItems();
      listChooseMode(); // end chooseMode
      $('#btn_bulk_handover').off('click');
      $.mobile.changePage("#handover");
    })

    $("#btn_bulk_carnet_pdf").click(function(){
      console.log("PDF clicked");
      getCheckedItems();
      listChooseMode(); // end chooseMode
      //$('#btn_bulk_carnet_pdf').off('click');
      //setTimeout(function(){$('#btn_bulk_carnet_pdf').on('click');},1000);
      switchOffButtonListener();
      downloadCarnetClicked(collection.bulk,true);
    })

    // prevent default pop up on hold and stuff:
    $("body").on("contextmenu", "#itemList", function() { return false; });

    lazyload(); // init lazy load (see head.mustache)
})

$("#collection").swipeleft(function(){window.history.forward()});

$("#collection").swiperight(function(){window.history.back()});

$("#filterinput").bind('keyup',function(e) {
          if (e.keyCode === 13)
          $("#filterinput").blur()
     });


// attach my own filter function to search input:
$.mobile.document.on( "filterablecreate", "#collection", function() {
    // changing jquery mobiles standard autocomplete for #itemList
    $( "#itemList" ).filterable( "option", "filterCallback", function( index, searchValue ) {
      //console.log(searchValue);
      let keywords = searchValue.split(" ");
      keywords = keywords.filter(function(e){return e}); // delete empty values

      let matches = 0;

      for (i in keywords)
      {
        if (  $(this).text().toLowerCase().includes(keywords[i]) )
        {
          matches++
        }
        else {
          matches--
        }
      }
      /*
      this is a bit hacked: here we check if "#scrollend" div exists in DOM and
      if so we trigger scrollEndListenerSearch in order to load more search result
      from the last search via bookmark. this makes sense to do when the filter returns
      a list of items so short that the user cant scroll down (the scrolling down to
      the end of the itemlist normally triggers this event --> see search.mustache
      function searchAndShow()! )
      */
      if($("#scrollend").length > 0){
        scrollEndListenerSearch(); // actually for search.mustache
      }


      if (matches == keywords.length)
      {
        $(this).show()
      }
      else {
        $(this).hide()
      }

    });
});

function getCheckedItems(){
  collection.bulk = [];
  let array = [];
  $(".itemChecked").siblings(".hiddenJSON").each(
    function(){collection.bulk.push(JSON.parse(this.innerText))})
  console.log(collection.bulk);
}

/*
<li>
  <img src="https://cdn-learn.adafruit.com/guides/images/000/000/144/medium500/659_orig.jpg?1448301064"></img>
  <div class="item">
      <b>Flora Board</b><br>
      <i>by Becky Stern</i><br>
      <div class="address">in Berlin, 12053 Berlin, Germany, Morusstr. 30</div>
      <span>This is a wonderful tool. A microcontroller, but build
      so that you can even sew it into sth</span>
  </div>
</li>
*/
/**
builds list object from single dingsa item.

@param: {object} object representing the dingsda item
*/
function makeItemCard(object){
  let item = document.createElement('li');
  $(item).addClass("itemInList");
  $(item).attr("id",object._id);
  if (object.inPossessionOf && !object.owners.includes(object.inPossessionOf))
  {
    if (object.owners.includes(glb_username))
    {
      $(item).addClass("loanedItem");
    }
    else {
      $(item).addClass("borrowedItem");
    }
  }
  let img = document.createElement('img');
  $(img).addClass("lazyload");
  let behindImg = document.createElement('div');
  $(behindImg).addClass("behindImg");
  let div = document.createElement('div');
  let name = document.createElement('b');
  $(name).addClass("itemname");
  let owners = document.createElement('i');
  let address = document.createElement('div');
  $(address).addClass("address");
  let description = document.createElement('span');
  let hidden = document.createElement('div');
  $(hidden).hide();
  $(hidden).addClass("hiddenJSON");
  $(hidden).html(JSON.stringify(object));
  let checkbox = document.createElement('div');
  $(checkbox).addClass("chooseOverlay");
  $(checkbox).hide();
  $(checkbox).html('<span type="checkbox" class="itemCheckbox"></span>');

  //img.src = "https://cdn-learn.adafruit.com/guides/images/000/000/144/medium500/659_orig.jpg?1448301064";
  let idOrLink = object.hyperlink;
  if (idOrLink == undefined || idOrLink == "")
  { idOrLink = API_BASE_URL+collection.searchDB+"/"+object._id }
  if (collection.searchDB !== "" && collection.searchDB !== undefined
      && idOrLink !== undefined && !idOrLink.split("/").includes("undefined")
      &&
      (
        collection.searchDB === "public"
        || (object._attachments && object._attachments["pic_small.jpg"])
      ) )
  {
    $(img).attr("data-src", idOrLink+"/pic_small.jpg");
    img.src = "icons/loading.png";
    $(img).attr("onerror",'null;this.src="icons/singleheart.png"');
    /*getPicAttachment(idOrLink,function(res){
      img.src = "data:image/jpeg;base64,"+res;
    },function(err){console.log(err);});*/
  }
  else {
    img.src = "icons/singleheart.png";
    //console.log("did not fetch a pic for: "+idOrLink+" from: "+collection.searchDB);
  }

  name.appendChild(document.createTextNode(object.name));

  owners.appendChild(document.createTextNode(" by "+object.owners))
  let addresslabel = object.location.address !== ""
  && object.location.address !== undefined ? object.location.address : object.location.insideOf;
  if (addresslabel == undefined || addresslabel===""){addresslabel =object.location.description}
  address.appendChild(document.createTextNode("in "+addresslabel))
  description.appendChild(document.createTextNode(object.other.description))

  item.appendChild(checkbox);
  item.appendChild(img);
  item.appendChild(behindImg);
  item.appendChild(hidden);

  div.appendChild(name);
  div.appendChild(document.createElement("br"))
  div.appendChild(owners);
  div.appendChild(document.createElement("br"))
  div.appendChild(address);
  div.appendChild(document.createElement("br"))
  div.appendChild(description);

  $(div).addClass("item");
  item.appendChild(div);
  return item;
}


function setNewCollectionSearchHistory(objects)
{
    objects = objects.filter(function(val){return val}); // remove all undefined from array
    // set global variable collection.detailView
    if(collection){

      collection.searchhistory.unshift(objects);
      // if more than 3 searches in history: delete oldest one:
      if (collection.searchhistory.length > 3){ collection.searchhistory.pop() }
    }
}

/**
renders Item Cards and prepends them to DOMs #itemlist.
usually used after searchQuery returned from Database using its return value.
uses makeItemCard(item) to build DOM objects (listitems).

@param {object} Array of dingsda objects to be rendered
*/
function drawItemCards(objects, fetchInMyPossession=true,bookmarklistener=undefined,alwaysAppend=false){

  objects = objects.filter(function(val){return val}); // remove all undefined from array

  $("#loadingGif").hide();
  //$("#itemList .item").parent().remove();

  // flag to hide items with hyperlink containing users DB if we look at public items
  //  (where we do not want to see our own stuff, right?!)
  let lookingAtPublicDB = collection.searchDB.includes("public") || collection.searchDB.includes("friends")

  for (i in objects)
  {
    let fromMyOwnDB = false;
    try{
      fromMyOwnDB = (objects[i].hyperlink.split("/").slice(-2)[0] === glb_username);
    }catch(err){console.log("error: seems to be old account missing hyperlink in docs");}

    /*  FIXME: documentation is guessed not sure if I miss sth.
    render a new item Card with the objects data but
    filter out users own items from publicDB view
     (that is: items from their Database not merely items owned by them!)
    */
    if ((!lookingAtPublicDB) || (lookingAtPublicDB && !fromMyOwnDB))
    {
      let item = makeItemCard(objects[i]);
      if (!alwaysAppend){
        $("#itemList").prepend(item);
      }
      else {
        $("#itemList").append(item);
      }


      $("#itemList").listview('refresh');
    }
    else {
      //console.log("deleted "+objects[i].name+" from objects");
      delete objects[i]
    }

  }

  // listen for scrollend to get into view and trigger bookmark load then:
  if (collection.bookmark !== undefined && bookmarklistener !== undefined)
  {
    addScrollEndListenerToCollection(bookmarklistener)
  }

// listen for clicks on listitems and open item in detailView:
  addItemCardClickListener();

  if (!lookingAtPublicDB && fetchInMyPossession)
  {
    getItemsInMyPossession(); // always???
  }
  lazyload(); // init lazy load (see head.mustache)

}

function addScrollEndListenerToCollection(listener)
{
  $("#itemList").append("<div id='scrollend'>... end of list. scroll for more ...</div>")

  document.addEventListener("scroll",listener)
}


function addItemCardClickListener(){
  $(".itemInList").off("click");
  $(".itemInList").click(function(e){
    console.log("item in list clicked:");
    if (collection.chooseMode)
    {
      $($(e.currentTarget).children()[0]).toggleClass("itemChecked");
    }
    else
    {
      let doc = $(e.currentTarget).children()[3].innerHTML;
      // go to itemDetail and set itemDetails variable to choosenItem:
      if(itemDetails){
        itemDetails.itemInFocus=JSON.parse(doc);
      }
      $.mobile.pageContainer.pagecontainer("change", "#itemDetails");
      //window.location.href = ("http://localhost:8080#itemDetails?data=test")
    }

  })

  // listen for tapholds on listitems, change to listChoose mode & mark item tapped
    $(".itemInList").off("taphold");
    $(".itemInList").taphold(function(e){
      console.log("item in list marked by taphold. Enterting listChooseMode:");
      //console.log(e.currentTarget);
      listChooseMode(e.currentTarget);

    },300)
}

function listChooseMode(target){
  if (target !== undefined && !collection.chooseMode)
  {
    //$(".itemChecked").removeClass("itemChecked");
    $(".chooseOverlay").show();
    $(".chooseButtons").show();
    console.log(target);
    collection.chooseMode=true;

    $("#btn_endChooseMenu").click(function(){listChooseMode()}); // end chooseMode
  }
  else {
    //switch back to normal listmode
    $(".chooseOverlay").hide();
    $(".chooseButtons").hide();
    collection.chooseMode=false;
  }
}

function countItemsInDB(callback=console.log){
  $.ajax({
    type: "GET",
    url: API_BASE_URL+glb_username,
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    success: function(result){
      /*
      divide by 2 because of every doc has a partner doc xxx-containerOf
      minus 3 because there are (atm) 3 extra docs in every userdb:
      &notifications and &inMyPossesion and &config
      (should change to only &config after the other two become databases)
      */
       callback((result.doc_count-3)/2);
    },
    error: function(err){console.log(err);},
    contentType:"application/json"
  });
}

/**
updates small batch in the header menu that indicates how many items are in users
database.
*/
function updateItemBatch(){
  updateBorrowItemsBatch();
  countItemsInDB(function(res){
    $(".collection_icon").addClass("anim_heartbeat");
    setTimeout(function(){
      $(".collection_badge").html(res);
      $(".collection_icon").removeClass("anim_heartbeat");
      $(".collection_badge").addClass("anim_hop");
      setTimeout(function(){$(".collection_badge").removeClass("anim_hop")},1050);
    },300);
  })
}

/**
updates small batch in the header menu that indicates how many items the user has
borrowed from other users.
*/
function updateBorrowItemsBatch()
{
  let query = {"data":[{"type":"getInMyPossession"}]}
  $.ajax({
    type: "POST",
    url: API_BASE_URL+glb_username,
    data: JSON.stringify(query),
    success: function(result){
      console.log("items in my possession but not owned by me:");
      console.log(result);
      $(".borrowedthings").html(result.length);
      $(".borrowedthings").addClass("anim_hop_left");
      setTimeout(function(){$(".borrowedthings").removeClass("anim_hop_left")},1050);
    },
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: console.log,
    contentType:"application/json"
  })
  /* // out for new inMyPossession DB
  getSingleItem("&inMyPossession",function(inMyPossesion){
    $(".borrowedthings").html(inMyPossesion.things.length);
    $(".borrowedthings").addClass("anim_hop_left");
    setTimeout(function(){$(".borrowedthings").removeClass("anim_hop_left")},1050);
  })
  */
}

// testing function for pagination
/**
searches db and checks if bookmark provided by API. if so, goes to next page
 till return values are empty.
 returns with two callbacks: callbackEach() gets called after every page with
 only data from page inside. callbackEnd() gets only called after the last page
 got read and returns all docs that have been returned in the process.
*/
function searchAndDoStepsInBetweenPages(
          db="machinaex",searchTerm={_id:""},callbackEach=console.log,
          callbackEnd=console.log,err=console.log,bookmark=null,outputEnd=[],stop=false)
{
    // send find() request to dingsda API:
    searchDB(db,searchTerm,function(result){
      /*
      if a bookmark is returned and there were docs in the response from the
      server, call the callbackEach() and then call this very function to flip
      further through the pages of returns until no docs are returned anymore...
      */
      if (result.bookmark && result.docs.length > 0){
        callbackEach(result)
        console.log(result.bookmark);
        outputEnd = outputEnd.concat(result.docs)
        searchAndDoStepsInBetweenPages(db, searchTerm,callbackEach,
          callbackEnd,err,result.bookmark,outputEnd)
      }
      else // ...then: stop looping and call the final callback:
      {
        console.log(outputEnd);
        callbackEnd(outputEnd)
      }
    },console.log,bookmark);

}

/**
sends HTTP request to dingsda API's find endpoint and passes response into callback
*/
function searchDB(db,searchTerm={_id:""},callback=console.log,err=console.log,bookmark=null){
    console.log(`sending find Request to ${db}`);

    $.ajax({
      type: "POST",
      url: API_BASE_URL+db,
      data: JSON.stringify({
            	"data":[{
            		"type":"findItems",
            		"doc":searchTerm,
                "bookmark":bookmark
            	}]
            }),
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      success: function(result){
         callback(result)
      },
      error: err,
      contentType:"application/json"
    });
}

function deleteItems(items)
{
  $.when($.each(items, function(){
      removeit(this._id,function(res){
        console.log(res);
      });
  })).done(function(){
    showToast("items will be deleted",900);
    setTimeout(function(){
      refreshCollection(console.log,true,true);
      updateItemBatch();
    },1000);
  })
}

function removeit(id, callbackdel=console.log)
{
  console.log("removeit function triggered!!!");
  if (id == "" || id == undefined)
  {
    return
  }

  console.log("trying to fetch originalObject from DB");

  getAPI({
    path:glb_username+"/"+id,
    data:{
      "data":[{
        "type":"fetch"
      }]
    },
    callback: function(res){

      console.log(res);
      console.log("attempting DELETE of object");

      let deletedata = {
          "data":[{
            "type":"deleteItems",
            "doc":res,
          }]
        }

      postAPI({
          path:glb_username+"/"+id,
          data:deletedata,
            callback: function(result){
            callbackdel(result)
            console.log("DELETED "+id+" successfully");
            console.log(result);
          },
          error: function(err){
            console.log("error in deleteit delete");
            callbackdel(err)
          }

      });
    },
    error: function(err){
      console.log("error in deleteit prefetch");
      callbackdel(err)
    }
  })

}


console.log($.mobile.document);







/*////////////////////////
CARNET ATA STUFF
*//////////////////////////

function downloadCarnetClicked(items, pdf=false){
  console.log(items);
  let carnetArray = [];
  for (i in items){
    carnetArray.push(items[i]._id);
  }
  console.log(carnetArray);
  if (pdf){
      openCarnetPDF(carnetArray)
      //renderCarnetATApdf(carnetArray);
  }
  else {
    postAPI({
        path:glb_username,
        data:{
                "data":[{
                  "type":"getCarnet",
                  "filetype":"csv",
                  "ids":carnetArray
                }]
              },
         callback: function(result){
          //console.log(result[0]);
          let myblob = new Blob([result],{type:'text/csv;charset=utf-8;'});
          if (navigator.msSaveBlob) { //IE10
              navigator.msSaveBlob(myblob, "carnetATA.csv");
          } else {
              let l = document.createElement("a");
              if (l.download !== undefined) {
                  let uri = URL.createObjectURL(myblob);
                  l.setAttribute("href", uri);
                  l.setAttribute("download", "carnetATA.csv");
                  l.style.visibility = 'hidden';
                  document.body.appendChild(l);
                  l.click(); // does not work in ios because ajax request before
                  document.body.removeChild(l);
              }
          }

        }

    });
  }

}


function openCarnetPDF(ids=undefined)
{
  //let win = window.open();
  postAPI({
      path:glb_username,
      data:{
            	"data":[{
            		"type":"getCarnet",
            		"filetype":"json",
                "ids":ids

            	}]
            },
       callback: function(result){
        console.log("show results of getCarnet:");
        console.log(result);

        renderCarnetATApdf(result);
      }

  });
}


function isInView(elem)
{
  if($(elem).length > 0){
    let docTop = $(window).scrollTop();
    let docBottom = docTop + $(window).height();
    let elemTop = $(elem).offset().top;
    let elemBottom = elemTop + $(elem).height();

    return ((elemBottom <= docBottom) && (elemTop >= docTop));
  }
  else {
    return false
  }

}


</script>

<div data-role="page" id="itemDetails">


    <style>

      .more_menu{
        position: fixed;
        z-index: 99;
        right: 10px;
        margin-top: 5vh;
      }

      .more_btn{
        width: 20px;
        height: 10px;
        float: right;
        opacity: 0.9;
      }

      .more_menu button{
        height: 2.5em;
        min-width: 50vw !important;
        padding: 2px;
        margin: 2px;
        text-shadow: 0px 0px 0px black !important;
      }

      .more_menu button:nth-child(3n+2){
        background-color: rgba(255, 0, 76, 1);
        color: rgba(255,242,205,1);
      }
      .more_menu button:nth-child(3){
        background-color: rgba(255,242,205,1);
      }
      .more_menu button:nth-child(4){
        background-color: rgba(171, 206, 204, 1);
      }

      .more_menu button {
        text-transform: lowercase;
      }

      #detailTitle{
        font-size: 1.1em;
        background-color: rgba(255, 0, 76, 1);
        color: rgba(255,242,205,1);
        text-shadow: 0px 0px 0px black !important;
      }

      #detailDescription {
        background-color: rgba(255,242,205,0.6);
      }

      #itemDetails_detailsContainer{
        margin-left: -1em;

      }

      .btn_request{
        font-size: 1.1em;
        bottom: 0;
        background-color: rgba(171, 206, 204, 0.8) !important;

        text-shadow: 0px 0px 0px black !important;
      }

      #itemDetails input{
        pointer-events: none;
        background-color: beige;
        border-color: rgba(0,0,0,0);
        border-width: 0px;
        border: 0px solid #f00 !important;
      }

      #itemDetails .inputlabel
      {
        font-size: 1em;
      }

      #itemDetails #getLocation{
        display: none;
      }

      #itemDetails #getLocation iframe{
        pointer-events: none;
      }

      #itemDetails #map>*{
        pointer-events: none;
      }

      #itemDetails .ui-flipswitch{
        display: none;
      }

      #itemDetails input:placeholder-shown{
        display: none;
      }

      #itemDetails .ui-shadow-inset{
        border-color: transparent;
      }

      #itemDetails #other\.visibility-button::after {
        display: none;
      }

      #itemDetails #other\.visibility-button{
        background-color: rgba(0, 0, 0, 0);
        border: 0px solid #f00 !important;
        pointer-events: none;
      }

      #itemDetails .bootstrap-tagsinput span::after{
        display: none;
      }

      #detailOwners::after{
        font-size: 0.8em;
        font-style: oblique;
        z-index: 99;
        position: absolute;
        /*color: blue;*/
        content: attr(data-before);
        background: rgba(255,255,255,1);
        right: 20px;
        padding: 3px;
      }

      .detailsLendout::after{
        color:red
      }

      .detailsBorrowed::after{
        color:blue
      }


    </style>


    <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
    <!-- END HEADER -->


  <!-- CONTENT -->
  <div role="main" class="ui-content" style="padding:0;">

    <div class="ui-grid-b" style="width:100%;margin-top:-20px;height:100%">

      <div class="more_menu">
        <div class="more_btn ui-btn">...</div>
        <div class="more_menu_btn_container">
          <button class="more_menu_btn editSingleItem_btn">edit</button>
          <button class="more_menu_btn moveSingleItem_btn">move</button>
          <button class="more_menu_btn borrow_handover_btn">handover</button>
          <button class="more_menu_btn deleteSingleItem_btn">delete</button>
        </div>
      </div>

      <div class="ui-block-a" style="width:100%;height:33vh;background-color:black">
        <img id="detailImg" src="icons/icon_512.png"
        style="height:100%" alt="big picture of item">
        </img>
      </div>

      <div class="ui-block-b" style="width:100%">
        <div id="detailTitle" class="ui-bar ui-bar-a">TITLE</div>
      </div>

      <div class="ui-block-a"style="width:100%">
              <div class="ui-bar" style="font-style:italic">
                by <span id="detailOwners">owners</span>
              </div>
      </div>

      <div id="itemDetail_location" class="ui-block-a" style="width:100%">

      </div>

      <div class="ui-block-a" style="width:100%">

        <div id=detailDescription class="ui-bar" style="height:18vh;overflow:scroll">
          description.
          <p>blablabla. Das ist so ein schönes Dingsbumms. wow. Ich bin sehr verwirrt.<br>
            Was mach ich jetzt bloß?
          </p>
          <p>blablabla. Das ist so ein schönes Dingsbumms. wow. Ich bin sehr verwirrt.<br>
            Was mach ich jetzt bloß?
          </p>
          <p>blablabla. Das ist so ein schönes Dingsbumms. wow. Ich bin sehr verwirrt.<br>
            Was mach ich jetzt bloß?
          </p>
        </div>
      </div>

      <div class="ui-block-a" style="width:100%">
        <div id="itemDetails_detailsContainer" class="ui-bar ui-bar-a">
         <!-- HERE GOES DETAILS FROM ADDNEW -->
        </div>
      </div>

      <div class="ui-block-a" style="width:100vw">
        <div class="borrow_handover_btn btn_request ui-btn" style="height:5vh">
          BORROW
        </div>
      </div>

    </div><!-- /grid-b -->

    </div>


  </div>
  <!-- END CONTENT -->

</div>


<script>

let itemDetails = {}

$( document ).on( "pageshow", "#itemDetails", function(e,ui) {
    console.log("just loaded itemDetails");
    console.log(ui.prevPage);

    $("#details").appendTo("#itemDetails_detailsContainer");
    $("#itemDetails_detailsContainer").trigger("create");
    $("#details").collapsible( "collapse" );
    $("#itemDetails_detailsContainer :input").attr("disabled", true);

    // move locationMoveable here
    $("#locationMoveable").appendTo("#itemDetail_location");
    $("#itemDetail_location").trigger("create");
    $("#locationMoveable").collapsible( "collapse" )

    clearForm(); // clear AddNew Form (in case we were editing before)

    showItemDetails();

    $(".more_menu_btn_container").hide();

})

$(".borrow_handover_btn").click(function(){
  console.log("#btn_borrow_handover_single clicked");

  if (itemDetails.itemInFocus.owners.includes(glb_username)) {
    console.log("users own item. therefore: handover or take back");
    // if not in possession of other user: it's a handover.
    if (itemDetails.itemInFocus.inPossessionOf === undefined ||
        itemDetails.itemInFocus.inPossessionOf.includes(glb_username) )
    {
      console.log("it's a handover");
      collection.bulk = [itemDetails.itemInFocus];
      $.mobile.pageContainer.pagecontainer("change", "#handover",
                 {allowSamePageTransition:true,transition: "slidefade" });
    }
    // otherwise it is a take back (which is a fully automated handover to the user themselves)
    else {
      console.log("it's a take back!");
      let newItem = itemDetails.itemInFocus;
      newItem.inPossessionOf = glb_username;
      handoverItem(newItem, callback=function(res){
        console.log(res);
        showToast("item will be taken back from Possessor.",1000)
        $.mobile.pageContainer.pagecontainer("change", "#notifications",
                   {allowSamePageTransition:true,transition: "slidefade" });
        refreshCollection();
        setTimeout(updateItemBatch,1200);
      })
    }

  }
  else {
    console.log("other users item. therefore: borrow request or return request");
    // if already in my Possesion: this must be a return to it's owners
    if (itemDetails.itemInFocus.inPossessionOf &&
        itemDetails.itemInFocus.inPossessionOf.includes(glb_username))
    {
      console.log("it's a return!");
      let newItem = itemDetails.itemInFocus;
      // second last item in hyperlink is dbOwner of things DB:
      let thingsdatabaseowner = itemDetails.itemInFocus.hyperlink.split("/");
      thingsdatabaseowner = thingsdatabaseowner[thingsdatabaseowner.length-2];
      console.log("to "+thingsdatabaseowner);
      newItem.inPossessionOf = thingsdatabaseowner;
      handoverItem(newItem, callback=function(res){
        console.log(res);
        showToast("send a return request to owner of thing.",1000)
        $.mobile.pageContainer.pagecontainer("change", "#collection",
                   {allowSamePageTransition:true,transition: "slidefade" });
        setTimeout(refreshCollection,1000);
        setTimeout(updateItemBatch,1200);
      })
    }
    // otherwise it is a borrow request to the owners
    else
    {
      collection.bulk = [itemDetails.itemInFocus];
      $.mobile.pageContainer.pagecontainer("change", "#borrow",
                 {allowSamePageTransition:true,transition: "slidefade" });
    }

  }

})

$(".more_btn").click(function(){
  console.log("MORE PRESSED");
  //show menu
  $(".more_menu_btn_container").toggle();
})

$(".moveSingleItem_btn").click(function(){
  clearForm(); // clearForm including Location
  $(".more_menu_btn").hide();
  console.log("moving SingleItem!");
  collection.bulk = [itemDetails.itemInFocus];
  $.mobile.pageContainer.pagecontainer("change", "#move",
             {allowSamePageTransition:true,transition: "slidefade" });
})

$(".editSingleItem_btn").click(function(){
  $(".more_menu_btn").hide();
  console.log("editing SingleItem!");
  $.mobile.pageContainer.pagecontainer("change", "#addNew",
             {allowSamePageTransition:true,transition: "slidefade" });
  // let addNew know that it is in editmode:
  addNew.editMode = true;
})

$(".deleteSingleItem_btn").click(function(){
  $(".more_menu_btn").hide();
  // confirm swal:
  swal({
    title: 'Are you sure?',
    text: "You won't be able to revert this!",
    type: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, delete it!'
  }).then((result) => {
    if (result.value) {
      console.log("deleting SingleItem!");
      deleteItems([itemDetails.itemInFocus]);
      setTimeout(function(){
        shiftItemFocus();
        showItemDetails();
      },1000)
    }
  })
})

$("#itemDetails").on( "swipeleft", function(e) {
  console.log("SWIPELEFT: next item");
  console.log(e);
  shiftItemFocus();
  showItemDetails();
/*  $.mobile.pageContainer.pagecontainer("change", "#itemDetails",
           {allowSamePageTransition:true,transition: "slidefade" }); */
 })

 $("#itemDetails").on( "swiperight", function(e) {
   console.log("SWIPERIGHT: prev item");
   shiftItemFocus(1);
   showItemDetails(); // not necessary. just for the looks of loading before pageshow
   /*$.mobile.pageContainer.pagecontainer("change", "#itemDetails",
            {allowSamePageTransition:true,transition: "slidefade",reverse: true  });*/
  })


function shiftItemFocus(shift=-1){
  //console.log(itemDetails.itemInFocus._id);
  let position = collection.searchhistory[0].findIndex(i => i._id === itemDetails.itemInFocus._id);
  console.log(position);
  if (position+shift > -1  && position+shift < collection.searchhistory[0].length)
  {
    position = position +shift;
    itemDetails.itemInFocus = collection.searchhistory[0][position];
  }
  else if (position+shift < 0){
    showToast(msg="no more items",1000);
     window.history.back();
  }
  else {
     window.history.back();
  }
}

function showItemDetails(){

  let mydoc = itemDetails.itemInFocus;
  if (mydoc)
  {
    // fill itemView with infos from Doc:
    let id = mydoc.hyperlink ? mydoc.hyperlink : API_BASE_URL+collection.searchDB+"/"+mydoc._id;
    id = id+"/pic_small.jpg";
    /*getPicAttachment(id,function(res){
      console.log("seeting new pic: " +res.substring(0,8));
      $("#detailImg").attr("src","data:image/jpeg;base64,"+res)
    });*/
    $("#containerOf").hide(); // hide containerOf. addNew.mustache code should show if needed
    $("#detailImg").attr("src",id); // if no picture found: use standard icon:
    $("#detailImg").attr("onerror",'null;this.src="icons/icon_512.png"')
    $("#detailTitle").html(mydoc.name);
    $("#detailOwners").html(mydoc.owners.toString());

    $("#detailOwners").removeClass("detailsBorrowed");
    $("#detailOwners").removeClass("detailsLendout");
    $("#detailOwners").attr('data-before',''); //reset content value for #detailOwners:after (see below)

    // hide / show edit / move / delete buttons depending on edit/move rights:
    if (!mydoc.owners.includes(glb_username))
    {
      $(".editSingleItem_btn").hide();
      $(".deleteSingleItem_btn").hide();
      if (mydoc.inPossessionOf === undefined || mydoc.inPossessionOf.includes(glb_username))
      {
          $(".moveSingleItem_btn").show();
      }
      else
      {
          $(".moveSingleItem_btn").hide();
      }

      // show name of user in possession of item in case it is ours but lent out:
      if (mydoc.inPossessionOf && mydoc.inPossessionOf.includes(glb_username))
      {
        console.log("BORROWED !");
        $("#detailOwners").addClass("detailsBorrowed");
        $("#detailOwners").attr('data-before',`borrowed from ${mydoc.owners}`); //anything is the 'content' value
      }

    }
    else {
      // full rights. show all buttons
      //$(".borrow_handover_btn").show(); // always the case so not needed here
      $(".editSingleItem_btn").show(); 
      $(".moveSingleItem_btn").show();
      $(".deleteSingleItem_btn").show();

      // show name of user this item is lend out to
      if (mydoc.inPossessionOf && !mydoc.inPossessionOf.includes(glb_username))
      {
        console.log("LEND OUT !");
        $("#detailOwners").addClass("detailsLendout");
        $("#detailOwners").attr('data-before',`lend out to ${mydoc.inPossessionOf}`); //anything is the 'content' value
      }

    }



    // change if borrow or handover button depending on itemownership and Possession:
    if(mydoc.owners.includes(glb_username) )
    {
      if (mydoc.inPossessionOf && !mydoc.inPossessionOf.includes(glb_username) )
      {
        $(".borrow_handover_btn").html("TAKE BACK")
      }
      else {
        $(".borrow_handover_btn").html("HANDOVER")
      }

    }
    else if (mydoc.inPossessionOf && mydoc.inPossessionOf.includes(glb_username))
    {
        if (mydoc.owners.includes(glb_username))
        {
            $(".borrow_handover_btn").html("HANDOVER")
        }
        else {
          $(".borrow_handover_btn").html("RETURN")
        }

    }
    else {
      $(".borrow_handover_btn").html("BORROW")
    }

    let detailLocaMini = mydoc.location.address ? mydoc.location.address : mydoc.location.description;
    if (mydoc.location.insideOf)
    {
      detailLocaMini = '<a style="font-size:0.8em" href=\'javascript:getSingleItem("'+
      mydoc.location.insideOf+
      '",function(res){clearForm();itemDetails.itemInFocus=res;showItemDetails();});\'>'+
      mydoc.location.insideOf+'</a>'
    }
    $("#detailLocation").html(detailLocaMini);
    $("#detailDescription").html(mydoc.other.description ? mydoc.other.description : "");

    fillForm(mydoc);
  }
}

function updateSingleItemInCollection(id,setIntoFocus=true)
{
  // get item by id
  getSingleItem(id,function(newDoc){
    console.log("got new doc:");
    console.log(newDoc);
    // find item in latest searchhistory
    collection.searchhistory[0].find((o, i) => {
      if (o._id === id) {
          // replace item in searchhistory with newer version:
          console.log("found it!");
          collection.searchhistory[0][i] = newDoc; // replace it in searchhistory

          if (setIntoFocus){
            itemDetails.itemInFocus = newDoc; // set it into focus
            showItemDetails();
          }
          // update inside .hiddenJSON div inside rendered collection view:
          console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
          $("#"+newDoc._id+ " .hiddenJSON").html(JSON.stringify(newDoc))
          // update rendered name:
          $("#"+newDoc._id+ " .itemname").html(newDoc.name)

          return true; // stop searching
      }
    });

  })

}

// in client_base
function getSingleItem(id,callback,error=console.log)
{
    // transform id into hyperlink in case no hyperlink was passed:
    if (!id.startsWith("https")){
      id = API_BASE_URL+glb_username+"/"+id;
    }
    console.log("fetching single Item: "+id);
    // get item json from DB
    $.ajax({
      type: "GET",
      url: id,
      success: callback,
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      error: error,
      contentType:"application/json"
    });

}


</script>

<div data-role="page" id="addNew">

  <style>

    .barcodebtn {
      height: 1.2em;
      float: right;
      border: 1px dotted lightgrey;
    }

    .back_btn {
      position: fixed;
      z-index: 99;
      right: 10px;
      margin-top: 5vh;
    }

    #addName{
      font-size: 1.1em;
      background-color: rgba(255, 0, 76, 1);
      color: rgba(255,242,205,1);
      text-shadow: 0px 0px 0px black !important;
      margin: 0;
      border-radius: 0;
    }

    #addName::-webkit-input-placeholder {
      color: rgba(255,255,255,0.8);
      text-shadow: 0px 0px 0px black !important;
    }

    #addOwners{
      width: 80%;
      margin-left: 20px;
      margin-top: 0px;
      font-size: 1em;
      text-shadow: 0px 0px 0px black !important;
    }

    #addLocation h3{
      width: 100% !important;
    }

    #addDescription {
      background-color: rgba(255,242,205,0.6);
      padding-top: 2px;
      margin: 0;
      height: 20vh !important;
    }

    /* map stuff: */
    #locationEditor .collapsible_right {
      margin-bottom: 0;
    }

    #getLocation{
      width: 100%;
      height: 50px;
    }

    #map{
      width: 100%;
      height: 30vh;
    }
    .locationContainer{
      display: flex;
      flex-direction: column;
    }
    .geodataContainer{
      display: flex;
      flex-direction: row;
    }
    .geotable{
      width: 45%;
      padding: 0;
    }

    /*flipswitch shizzl*/
    .custom-size-flipswitch.ui-flipswitch .ui-btn.ui-flipswitch-on {
        text-indent: -15.9em;
    }
    .custom-size-flipswitch.ui-flipswitch .ui-flipswitch-off {
        text-indent: 0.5em;
    }
    .custom-size-flipswitch.ui-flipswitch {
        width: 98%;
        padding-left: 2%;
    }
    .custom-size-flipswitch.ui-flipswitch.ui-flipswitch-active {
        width: 10%;
        padding-left: 85%;
    }


    /* photo shizzl*/
    #addPhoto{
      max-width: 100%;
      height: 33vh;
      position: absolute;
      top: 3.2em;
      pointer-events: none;
    }

    .fileContainer {
        overflow: hidden;
        min-height: 30vh;
        width: 100%;
        z-index: 0;
        opacity: 0
    }

    .fileContainer [type=file] {
        cursor: inherit;
        display: block;
        font-size: 999px;
        filter: alpha(opacity=0);
        min-height: 23vh;
        min-width: 100%;
        opacity: 0;
        position: absolute;
        right: 0;
        text-align: right;
        top: 0;
    }


    .collapsible_right a{
      text-align: center !important;
      background-color: rgba(200, 200, 200, 0.4) !important;
    }

    #details{
      margin:0;
    }

    #details a{
      margin: 0;
      font-size: 1.5em;
      line-height: 0.05em;
    }

    .bootstrap-tagsinput .tag {border: 1px solid rgba(0,0,0,0.3); line-height: 2em;
      border-radius: 15%;padding:3px; background-color: rgba(250,250,250,0.2);color: black }
    .bootstrap-tagsinput {color: black;background-color: rgba(0,0,0,0);border: 0px solid black;
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075); width: 100%}

    .smallfont {font-size: 6px !important;line-height: 50%}
    .mediumfont {font-size: 12px !important;line-height: 100%}


    /* overwriting eaysautocompletes behaviour */
    .easy-autocomplete{
      width:100% !important
    }

  </style>

  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content" style="padding:0;">

    <div class="ui-grid-b" style="width:100%;margin-top:-20px;height:100%">

      <div class="back_btn more_btn ui-btn">x</div>

      <div class="ui-block-a" style="width:100%;height:33vh;background-color:black;
        display: flex;flex-direction: row;justify-content: center;">
        <label class="fileContainer ui-btn">
          <input type="file" accept="image/*" id="photo_upload" multiple data-role="none"/>
        </label>
        <img id="addPhoto" src="" alt="big picture of item"></img>
      </div>

      <div class="ui-block-b" style="width:100%">
        <input id="addName" class="ui-bar ui-bar-a" placeholder="name it!"></div>
      </div>

      <div class="ui-block-a" style="padding:0px; margin:0px;">
        <div class="ui-bar"
          style="font-style:italic; display:flex; flex-direction:row; padding: 0px;margin:0">
            <span style="padding-left: 0.8em;">by</span> <div id="addOwners"
              placeholder="owners" contenteditable="true"></input>
        </div>
      </div>

      <!-- START LOCATIONEDITOR -->

      <div id="locationEditor" class="ui-block-a" style="width:100%">

      </div>

      <!-- END LOCATIONEDITOR -->

      <div class="ui-block-a" style="width:100%">
        <textarea id=addDescription class="ui-bar" placeholder="describe it!"></textarea>
      </div>

          <!-- START DETAILS -->

        <div id="addNew_detailsContainer">
          <div id="details" class="collapsible_right ui-block-a" data-role="collapsible"
              data-mini="true" data-collapsed-icon="info"
              data-expanded-icon="arrow-u" data-collapsed="true" data-iconpos="none">
              <h3 style="width:100vw;">...</h3>

              <span class="inputlabel">tags / keywords:</span>
              <input id="other.tags" type="text" placeholder="type tag and hit enter"
                data-role="tagsinput" value="" />

              <span class="inputlabel">barcode:</span>
                <img class="barcodebtn" src="./icons/barcode.png" onclick="scan('#other\\.barcode')">
              <input type="text" id="other.barcode" placeholder="EAN, ISBN or UPC"
                />

              <span class="inputlabel">count / number of pieces:</span>
              <input type="text" id="other.count"
                placeholder="how many items are summerized in this entry?"
                />

              <span class="inputlabel">weight per item:</span>
              <input type="text" id="other.weight"
                placeholder="don't forget to include the unit (e.g. kg)"
                />

              <span class="inputlabel">value per item:</span>
              <input type="text" id="other.value"
                placeholder="EUR? USD? CHF?" />

              <span class="inputlabel">country of origin:</span>
              <input type="text" id="other.madein"
                placeholder="made in..." />

              <!--<div data-role="collapsible" data-mini="true" data-collapsed-icon="heart">
                <h3 class="mediumfont" style="width:100%">Visibility</h3>-->

                  <select name="visibility" class="mediumfont" id="other.visibility">
                    <option value="private">visible only to owners</option>
                    <option value="friends">visible to friends <span class="smallfont">(atm: like private)</span></option>
                    <option value="friends2nd" disabled>visible to friends of friends</option>
                    <option value="public" selected>visible to friends in spe (public)</option>
                  </select>

            <!--  </div> -->
            <br>
              unique id:
              <input type="text" id="_id" placeholder="no unique id so far" disabled>
              <div id="hyperlink" hidden></div>




          <!-- END DETAILS -->


          </div>
        </div>

      <div class="ui-block-a" style="width:100vw">
        <div id="btn_add_next" class="btn_request ui-btn" style="height:8vh">ADD / NEXT</div>
      </div>

    </div><!-- /grid-b -->

    </div>

  </div>
  <!-- END CONTENT -->

</div>


<script>

let addNew = {
  urlStandInImg: "assets/images/takepicture.png",
  editMode: false
};

const gmapsExists = true;


$("#addNew input").bind('keyup',function(e) {
          if (e.keyCode === 13)
          {
            $(e.target).blur()
          }

     });

$( document ).on( "pageshow", "#addNew", function(e,ui) {
    console.log(window.location.search);
    console.log("just loaded itemDetails");
    console.log(ui.prevPage);


    $("#details").appendTo("#addNew_detailsContainer");
    $("#addNew_detailsContainer").trigger("create");
    //$("#details").collapsible( "collapse" )
    $("#addNew_detailsContainer :input").attr("disabled", false);

    if (base.hashhistory && base.hashhistory[1]
      && !base.hashhistory[1].includes("#barcode"))
    {
      clearForm();
      $("#addPhoto").attr("src", addNew.urlStandInImg);
      
      console.log("CLEARING FORM OF ADDNEW");
    }
    else {
      console.log("NOT CLEARING ANYTHING");
    }



    $("#locationMoveable").appendTo("#locationEditor");
    $("#locationEditor").trigger("create");
    $("#locationMoveable").collapsible( "collapse" )

    if (addNew.editMode === false)
    {
      // if not in editmode
      $("#addOwners").html(glb_username)
      $("#btn_add_next").html("ADD / NEXT")
    }
    else {
      console.log(addNew.editMode);
      // if in editmode:
      addNew.editMode = false; //switchoff editmode for next time
      // fill AddItemForm with singleItem in focus:
      let id = itemDetails.itemInFocus.hyperlink;
      if (id === undefined){
        id = itemDetails.itemInFocus._id
      }
      getSingleItem(id,function(r){
        fillForm(r);
      })
      $("#btn_add_next").html("SAVE EDITS");
    }

    // bind easyAutocomplete to insideOf
    var options = {
      //url: "alldocs.json",

      data: collection.searchhistory[0],

      getValue: "name",

      list: {
        match: {
          enabled: true
        },
        maxNumberOfElements: 8,
        onSelectItemEvent: function() {
    			var value = $("#insideOf").getSelectedItemData()._id;
          console.log("doing "+ value);
    			$("#insideOf").val(value).trigger("change");
    		}
      },

      template: {
        type: "custom",
        method: function(value, item) {
          console.log(value);
          console.log(item);
          return "<span class='flag flag-" + item + "' ></span>" + value;
        }
      },

      /*theme: "round",*/

      ajaxSettings: {
        xhrFields: { withCredentials: true }, // to make AuthCookie ok
      }

    };
    $("#insideOf").easyAutocomplete(options);


})

$(document).ready(function(){



  // init gmaps
  fillLocationForm({description: "",address: "",latitude:null,longitude:null})

  $('#getLocation').click(autoGetLocation);

  $('#address').change(function(){
    $('.locationdescription').html($('#address').val())
  })

  $(".back_btn").click(function(){
    window.history.back();
  })

  $("#btn_add_next").click(function(){
    console.log("ADD button clicked");
    btn_add_update();
  })

  document.getElementById("addPhoto").onerror = function(err){
    console.log("error loading picture #addPhoto:");
    console.log(err);
    $("#addPhoto").attr("src", addNew.urlStandInImg);
  }

})

function updateInsideOfFlipSwitch(on){
  if (on){
    $('#fliplocation').parent().addClass('ui-flipswitch-active');
    $('#fliplocation').prop('checked', true);
    updateInsideOfContainer()
  }
  else {
    $('#fliplocation').parent().removeClass('ui-flipswitch-active');
    $('#fliplocation').prop('checked', false);
    updateInsideOfContainer()
  }
}



$("#fliplocation").parent().click(function(e){
  updateInsideOfContainer();
})

function updateInsideOfContainer()
{
  if ($("#fliplocation").prop("checked"))
  {
    $(".locationContainer").hide();
    $("#insideOfContainer").show();
  }
  else
  {
    $(".locationContainer").show();
    $("#insideOfContainer").hide();
  }
}


document.getElementById("photo_upload").addEventListener("change",
  function(){
    console.log("got pic, will resize now:");
    resizeBase64image(document.getElementById("photo_upload"),
    function(base64img){
      console.log("resized pic. will add it to src");
      document.getElementById("addPhoto").src = base64img;
    });
});


  function refreshMap()
  {
    let latitude = $('#latitude').val();
    let longitude = $('#longitude').val();

    if(latitude != "" && longitude != "")
    {
      $('#map').locationpicker({
        radius: 0,
        inputBinding: {
            locationNameInput: $('#address'),
            latitudeInput: $('#latitude'),
            longitudeInput: $('#longitude')
        },
        location:{
          latitude:latitude,
          longitude:longitude
        }

      })

      setTimeout(function() {

        let out = $("#map").locationpicker("map").location.formattedAddress;
        console.log(out);
        $("#address").val(out);
        if($("#insideOf").val() == "" || $("#insideOf").val() == undefined)
        {
          if($("#description").val() == "" || $("#description").val() == undefined)
          {
              $('.locationdescription').html($('#address').val())
          }
          else
          {
              $('.locationdescription').html($('#description').val())
          }

        }

      },300)
    }

    // refresh map (should be inside of mapplugin)

  }


  function fillLocationForm(input){

      $('#address').val(input.address);
      $('#description').val(input.description);

      $('#map').locationpicker({
        location: {
            latitude: input.latitude,
            longitude: input.longitude
        },
        addressFormat:
        "House Number, Street Direction, Street Name, Street Suffix, City, State, Zip, Country",
        radius: 0,
        inputBinding: {
            locationNameInput: $('#address'),
            latitudeInput: $('#latitude'),
            longitudeInput: $('#longitude')
        },
        enableAutocomplete: true
      });
  }

  function autoGetLocation()
  {
    console.log("get location clicked");
    if ("geolocation" in navigator)  {
      console.log("trying to get geolocation from navigator");
      /* geolocation is available*/
      navigator.geolocation.getCurrentPosition(function(location) {
      console.log(location.coords.latitude);
      $('#latitude').val(location.coords.latitude);
      console.log(location.coords.longitude);
      $('#longitude').val(location.coords.longitude);
      console.log(location.coords.accuracy);
      setTimeout(function(){
        refreshMap();
      },1000);
    },function(){
      swal({html:"could not fetch location. <br><br>location services enabled?",
       toast:true,customClass:"whiteletters",timer:3200,showConfirmButton:false});
     })
    } else {
      /* geolocation IS NOT available */
      console.log("geolocation API not available");
    }

  }


  function resizeBase64image(input, callback = console.log){

    // TO DO: update preview_photo.oldsource after upload!!!

    let canvas = document.createElement("canvas");
    let file = input.files[0];

    if (file){
      let reader = new FileReader();
      reader.onload = function(e) {
        console.log("loaded");
        //let img = document.getElementById("camera_img");
        let img = document.createElement("img");
        img.src = e.target.result;

        img.addEventListener('load', function(){
          let ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);

          let MAX_WIDTH = 400;
          let MAX_HEIGHT = 400;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > MAX_WIDTH) {
              height *= MAX_WIDTH / width;
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width *= MAX_HEIGHT / height;
              height = MAX_HEIGHT;
            }
          }
          canvas.width = width;canvas.height = height;
          ctx = canvas.getContext("2d");
          ctx.drawImage(img,0,0,width,height);
          let dataurl = canvas.toDataURL("image/jpeg");
          // Now post the dataurl to a server:
          //console.log(dataurl);
          callback(dataurl)
        })
      }

      reader.readAsDataURL(file);
    }


  }

///// UPDATE FUNCTIONS //////

function btn_add_update()
{
    var basicout = getAllInputs();

    //basicout = JSON.parse(basicout);
    //console.log(basicout);

    //check if ID provided:
    if (basicout._id != undefined && basicout._id != "")
    {
      console.log("ID provided.\nErgo: item will be updated if it exists");

      updateit(basicout,function(res){
        if (config.clearFormsAfterUpdate)
        {
          clearForm();
        }
        console.log(res);
        if(res.ok == true)
        {
          swal({text:"UPDATED SUCCESSFULLY\n(pic might need reload)", toast:true, timer:500,
            showConfirmButton:false, position:"center",customClass:"whiteletters"
          }).then(function(){
              shiftItemFocus(0);
              setTimeout(showItemDetails,500);
              window.history.back();
              updateSingleItemInCollection(basicout._id);
            /*  refreshCollection(function(){
            },true,true);*/
          });
        }
        else {
          swal({title:"UPDATE ERROR",text:res.statusText, toast:true,customClass:"whiteletters"});
          console.log(res);
        }
      })

    }
    else
    {
      // if not name in owners, put in user alone:
      if (!basicout.hasOwnProperty("owners")){
          $('#owners').val(glb_username);
          basicout.owners=[ glb_username ];
         }

      if (checkIfBasicDataProvided(basicout))
      {
          console.log("No ID provided.\nErgo: new item will be added")
          //console.log(createID(true));
          //basicout._id = createID(false);
          //fillForm(basicout);
          addit(basicout, function(res){
            basicout._id = res.id;

            //fillForm(basicout);

            // if called from addNew: clearForm with the exeption

            clearFormsAfterAdd();

            //console.log(res);
            if(res.ok == true)
            {
              swal({
                text:"ADDED SUCCESSFULLY", toast:true,
                timer:1200,showConfirmButton:false,
                position:"center",customClass:"whiteletters"
              });
              updateItemBatch();
            }
            else {
              swal({text:"ADD ERROR", toast:true,customClass:"whiteletters"});
              console.log(res);
            }

          })

      }
      else
      {
        let missing = ["name","location"];
        if (basicout.hasOwnProperty("name") &&  basicout.name != "")
        {
          missing.splice(missing.indexOf("name"),1)
        }
        if (basicout.hasOwnProperty("location"))
        {
            missing.splice(missing.indexOf("location"),1)
        }

        swal({
            html:"please provide at least <br><b>"+missing+"</b>"
            , toast:true, timer:2000,showConfirmButton:false, position:"center",
            customClass:"whiteletters"
        })
        console.log("The basic data requirements are not met. please provide at"
        +" least:...");
      }
    }

};


// soll: alle textinputfelder usw. in einem objekt zusammenfuegen und uebergeben:
function getAllInputs()
{

  let output = {};

  output._id = $("#_id").val() != "" ? $("#_id").val() : null ;
  output.hyperlink = $("#hyperlink").html() != "" ? $("#hyperlink").html() : null
  output.name = $("#addName").val() != "" ? $("#addName").val() : null ;
  output.owners = $("#addOwners").html().replace(/ /g,"").split(",");
  output.location = {
    address: $("#address").val(),
    description: $("#description").val(),
    latitude: parseFloat($("#latitude").val()),
    longitude: parseFloat($("#longitude").val()),
    insideOf: $("#insideOf").val()
  }
  output.other = {
    tags:$("#other\\.tags").tagsinput("items"),
    visibility:[$("#other\\.visibility").val()],
    description:$("#addDescription").val()
  }
  // add all inputs that start with other but other.tags to var output.other:
  $('input[id^="other"]:not(#other\\.tags)').each(
    function(){
      // to do: do this split with dotize instead:
      output.other[$(this).attr("id").split(".")[1]] = $(this).val();
    }
  )
  //output.hyperlink = hyperlink;

  //delete all empty bits:
  $.each(output, function(key, value){
    if (value === "" || value === null || value === undefined){
        delete output[key];
    }
  });
  $.each(output.location, function(key, value){
    if (value === "" || value === null || value === undefined){
        delete output.location[key];
    }
  });
  if (!output.location.address && !output.location.description && !output.location.insideOf)
  {
    delete output.location;
  }
  $.each(output.other, function(key, value){
    if (value === "" || value === null || value === undefined){
        delete output.other[key];
    }
  });

  console.log(output);
  return output;

};

function clearFormsAfterAdd()
{
  $("#addName").val("");
  $("#_id").val("");

  $("#addPhoto").attr("src",addNew.urlStandInImg);

  // location stays after Add
  //$("#address").val(""),
  //$("#description").val(""),
  //$("#latitude").val(""),
  //$("#longitude").val(""),
  //$("#insideOf").val("")

  //$("#other\\.tags").tagsinput("removeAll"),
  //$("#other\\.visibility").val(""),
  $("#addDescription").val("")

  // clear all inputs that start with other but other.tags to var output.other:

  /*
  $('input[id^="other"]:not(#other\\.tags)').each(
    function(){
      // to do: do this split with dotize instead:
      $(this).val("");
    }
  )
  */
}


function clearForm(){
  $("#addName").val("");
  $("#_id").val("");

  $("#addPhoto").attr("src",addNew.urlStandInImg);

  $("#address").val("");
  $("#description").val("");
  $("#latitude").val("");
  $("#longitude").val("");
  $("#insideOf").val("");

  $("#other\\.containerOf").html("");
  $("#containerOf").hide();


  $(".locationdescription").html("");
  $("#insideOf_name").html("");
  $("#insideOf_name").attr("href","");
  updateInsideOfFlipSwitch(false);

  $("#other\\.tags").tagsinput("removeAll");
  $("#other\\.visibility").val("public").change();

  $("#addDescription").val("");

  // clear all inputs that start with other but other.tags to var output.other:

  $('input[id^="other"]:not(#other\\.tags)').each(
    function(){
      // to do: do this split with dotize instead:
      $(this).val("");
    }
  )

}

function checkIfBasicDataProvided(object)
{
  console.log(object);
  if (object.hasOwnProperty("name")
    && object.hasOwnProperty("location"))
  {
    return true;
  }
  else
  {
    return false;
  }
}

/// API FUNCTIONS ////


//// ADD / update

function addit(obj,callback=console.log)
{
  let data = {
            "data":[{
              "type":"addItems",
              "doc":obj,
            }]
          };

  // photo upload:
  if ( document.getElementById("addPhoto").src !== addNew.urlStandInImg)
  {
    data.data[0].pic = document.getElementById("addPhoto").src;
  }
  console.log("attempting to add item to dingsda");
  postAPI({
      path:glb_username,
      data:data,
       callback: function(result){
        collection.reloadOnNextClick = true;
        callback(result)
      }

  });

}


function postAPI({path="", data =null, callback=console.log,
                  error=function(err)
                  {/*swal({text:err.responseText})*/;
                  console.log(err.responseText);
                  callback(err)
                }})
{

  $.ajax({
    type: "POST",
    url: API_BASE_URL+path,
    data: JSON.stringify(data),
    success: callback,
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: error
    ,contentType:"application/json"
  });

}

function getAPI({path="", data=null, callback=console.log, error=function(err)
                  {console.log(err.responseText)}})
{

  $.ajax({
    type: "GET",
    url: API_BASE_URL+path,
    data: data,
    success: callback,
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: error
    //,dataType: "application/json"
    ,contentType:"application/json"
  });

}





function fillForm(object)
{

  console.log(object);

  if(object.hyperlink !== undefined && object.hyperlink !== ""){
    $('#hyperlink').html(object.hyperlink);
  }

  $("#addPhoto").attr("src",object.hyperlink+"/pic_small.jpg");

  // otherwise: start filling the form
  if(object.other !== undefined)
  {
    if (object.other.borrowable === undefined){object.other.borrowable = "not"};
    if (object.other.visibility === undefined){object.other.visibility = "not"};

    $('#other\\.barcode').val(object.other.barcode);
    $('#other\\.visibility').val(object.other.visibility).change();
    //$('#other\\.borrowable').val(object.other.borrowable).change();
    //$('#other\\.borrowby').val(object.other.borrowby).change();

    $('#addDescription').val(object.other.description);
    $('#other\\.value').val(object.other.value);
    $('#other\\.weight').val(object.other.weight);
    $('#other\\.madein').val(object.other.madein);
    $('#other\\.count').val(object.other.count);
    $('#other\\.tags').val( object.other.tags);

    /*
    fetch containerOf doc of this item
    and show containerOf fields if not empty:
    (changed with betterContainerOf branch)
    */
    console.log("fetching -containerOf");
    getSingleItem(object.hyperlink+"-containerOf",function(res){
      console.log("-containerOf:");console.log(res);
      if(res.containerOf !== undefined && res.containerOf.length > 0 )
      {
        $('#containerOf').show();
        $('#other\\.containerOf').html("");
        for (item in res.containerOf)
        {
          let links = "";
          links = links + '<a href=\'javascript:getSingleItem("'+
          res.containerOf[item]+
          '",function(res){clearForm();itemDetails.itemInFocus=res;showItemDetails();})\'>'+
          res.containerOf[item]+' </a><br>'
          getSingleItem(res.containerOf[item],function(res2){
              links = res2.name + " : <br>" + links;
              $('#other\\.containerOf').append(links);
          });
        }
      }else{
        $('#containerOf').hide()
        $('#other\\.containerOf').html("");
      }

    });


    $("#other\\.tags").tagsinput("removeAll");
    for (item in object.other.tags)
    {
        $('#other\\.tags').tagsinput('add', object.other.tags[item]);
    }
  }

  $('#_id').val(object._id);
  $('#addName').val(object.name);
  $('#addOwners').html(object.owners.toString());
  //$('#location').val(object.location); // old version from location always string

  //////////////////////////////////////
  // LOCATION OBJECT w/ map plugin:
  // TO DO: establish DOT NOTATION FOR LOCATION OBJECT!!!! (maybe include dotize???)

  if(typeof object.location === 'string')
  {
    console.log("location is a string");
    $('#description').val(object.location);
    $('.locationdescription').html(object.location);
  }
  else if (object.location !== null && typeof object.location === 'object')
  {
    console.log("location is an object");
    $('#description').val(object.location.description);
    $('.locationdescription').html(object.location.description);
    $('#address').val(object.location.address);
    $('#latitude').val(object.location.latitude);
    $('#longitude').val(object.location.longitude);
    $('#insideOf').val(object.location.insideOf);
      // fill also name of object in insideOf:
    if (object.location.insideOf !== undefined && object.location.insideOf !== "")
    {
      $('.locationdescription').html(object.location.insideOf);
      getSingleItem(object.location.insideOf,insideOfUpdated);
      updateInsideOfFlipSwitch(true);
    }
    else {
      updateInsideOfFlipSwitch(false);
      $("#insideOf_name").html("");
    }


  }

  ///////////////////////////////////////
  if(gmapsExists) // if the gmaps locationpicker module exists:
  {
    refreshMap();
  }

};


function updateit(obj,callback=console.log)
{
  console.log("trying to fetch originalObject from DB");
  console.log(obj);

  let path = API_BASE_URL+glb_username+"/"+obj._id;
  if (obj.hyperlink !== undefined && obj.hyperlink != "")
  { path = obj.hyperlink }

  getSingleItem(path, function(res){

      console.log(res);
      console.log("merging oldObj and formContents");
      let newObj = Object.assign({}, res, obj);
      console.log(newObj);
      console.log("attempting update of object");

      let newdata = {
          "data":[{
            "type":"update",
            "doc":newObj,
            //pic:document.getElementById("preview_photo").src
            //"doc":{_id:"33","other.visibility":["friends"]}
          }]
        }
        //let reloadAfterUpdate = false;
        // photo upload:
        if (document.getElementById("addPhoto").src.startsWith("data:image/jpeg;base64") )
        {
          console.log("PIC added to newdata!!!");
          newdata.data[0].pic = document.getElementById("addPhoto").src;

        }
        //console.log(newdata);
        // write into DB
        $.ajax({
          type: "POST",
          url: path,
          data: JSON.stringify(newdata),
          success: function(res){
            callback(res)
          },
          xhrFields: { withCredentials: true }, // to make AuthCookie ok
          error: callback,
          contentType:"application/json"
        });
    },
    function(err){callback(err)}
  )

}

function insideOfUpdated(res)
{
  if (res._id !== undefined)
  {
    $('#insideOf_name').html(res.name);
    $('.locationdescription').html(res.name+" . "+res.location.description);
    $('#insideOf_name').attr("href", 'javascript:getSingleItem("'+res._id+
    '",function(res){clearForm();itemDetails.itemInFocus=res;showItemDetails();});')
  }

}

</script>

<div data-role="page" id="move">

  <style>

    #locationEditor_Move .ui-collapsible-content{
      background-color: #fff2cd;
      text-shadow: 0px 0px 0px black !important;
      width: 100%;
      margin-left:-1em;
    }

    #locationEditor_Move #map{
      height: 20vh;
    }

    #locationEditor_Move .ui-collapsible-heading{
      display: none
    }

  </style>

  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content" style="background-color:#abcecc;margin-bottom:10vh;">
    Where do you want to move these items to ?
    <br>

  <div id="locationEditor_Move">


  </div>


  <div id="btn_move_items" class="btn_request ui-btn"
    style="height:10vh;width:100%;left:-1em;bottom:-1em;background-color:#ff004c!important;
    color:#fff2cd;z-index:3;position:fixed">
    MOVE ITEMS</div>


  </div>
  <!-- END CONTENT -->

</div>


<script>

$( document ).on( "pageshow", "#move", function(e,ui) {
    //console.log(window.location.search);
    console.log("just loaded move");
    //console.log(ui.prevPage);

    $("#move .ui-content li").remove()

    $("#locationMoveable").appendTo("#locationEditor_Move");
    $("#locationEditor_Move").trigger("create");
    $("#locationMoveable").collapsible( "expand" )

    for(value of collection.bulk)
    {
      $("#move .ui-content").append("<li>"+value.name)
    }
})

$("#btn_move_items").click(function(){
  let newlocation = getAllInputs().location;

  if (newlocation !== undefined)
  {
    console.log("items will be moved to new location:");
    console.log(newlocation);

    for(value of collection.bulk)
    {
      value.location = newlocation;
      //updateItem(value);
      moveItem(value)
    }

    showToast("items will be moved",800);
    setTimeout(function(){
      refreshCollection(console.log,true,true);
    },1000);
    window.history.back();
  }

})

function moveItem(obj, callback=console.log)
{
  console.log("trying to move item");

  let path = API_BASE_URL+glb_username+"/"+obj._id;
  if (obj.hyperlink !== undefined && obj.hyperlink != "")
  { path = obj.hyperlink }

  let dataOut = {
    "data":
          [{
            "type":"move",
            "location":obj.location
          }]
    }

  $.ajax({
    type: "POST",
    url: path,
    data: JSON.stringify(dataOut),
    success: callback,
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: callback,
    contentType:"application/json"
  });
}


function updateItem(obj,picIncluded=false,callback=console.log)
{
  console.log("trying to fetch originalObject from DB");
  console.log(obj);

  let path = API_BASE_URL+glb_username+"/"+obj._id;
  if (obj.hyperlink !== undefined && obj.hyperlink != "")
  { path = obj.hyperlink }

  getSingleItem(path, function(res){

      console.log(res);
      console.log("merging oldObj and formContents");
      let newObj = Object.assign({}, res, obj);
      console.log(newObj);
      console.log("attempting update of object");

      let newdata = {
          "data":[{
            "type":"update",
            "doc":newObj,
            //pic:document.getElementById("preview_photo").src
          }]
        }

        // excluded picupdate. should have its own function, i think

        // write into DB
        $.ajax({
          type: "POST",
          url: path,
          data: JSON.stringify(newdata),
          success: callback,
          xhrFields: { withCredentials: true }, // to make AuthCookie ok
          error: callback,
          contentType:"application/json"
        });
    },
    function(err){callback(err)}
  )

}

/* // exists already inside itemDetails.mustache
function getSingleItem(id,callback,error=console.log)
{
    // transform id into hyperlink in case no hyperlink was passed:
    if (!id.startsWith("https")){
      id = API_BASE_URL+glb_username+"/"+id;
    }
    console.log("fetching single Item: "+id);
    // get item json from DB
    $.ajax({
      type: "GET",
      url: id,
      success: callback,
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      error: error,
      contentType:"application/json"
    });

}
*/

</script>

<div data-role="page" id="handover">

  <style>

    iframe {
      left: -10px;
      height: 100vh;
      width: 95vw;
    }

  </style>

  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content">
    Who do you want to hand these items over to?
    <br>
    <input id="newPossessor" type="text"></input>

  <div id="btn_handover_items" class="btn_request ui-btn"
    style="height:10vh;width:100%;left:-1em;bottom:-1em;background-color:#ff004c!important;
    color:#fff2cd;z-index:3;position:fixed">
    HANDOVER ITEMS</div>

  </div>

  <!-- END CONTENT -->

</div>


<script>

$( document ).on( "pageshow", "#handover", function(e,ui) {
    console.log(window.location.search);
    console.log("just loaded handover");
    console.log(ui.prevPage);

    $("#handover .ui-content li").remove()

    for(value of collection.bulk)
    {
      $("#handover .ui-content").append("<li>"+value.name)
    }
})

$("#btn_handover_items").click(function(){
  let newPossessor = $("#newPossessor").val();

  if (newPossessor !== undefined)
  {
    console.log("items will be handed over to new possesor:");
    console.log(newPossessor);

    for(value of collection.bulk)
    {
      value.inPossessionOf = newPossessor;
      //updateItem(value);
      handoverItem(value,function(res){
        if (!res.ok){
          console.log("item could not be announced for handover. probably already in process or race condition");
          swal({html:"something went wrong.<br> did you spell the username correct?"});
        }
        else {
          updateNotificationsBatch();
        }
      })
    }

    showToast("items will be handed over",800);

    setTimeout(function(){ // this could happen more after the first or last response received back if proper async. (see promise.all())
      $.mobile.pageContainer.pagecontainer("change", "#notifications",
                 {allowSamePageTransition:true,transition: "slidefade" });
    },300)

  }

})

function handoverItem(obj, callback=console.log)
{
  console.log("trying to send handover announcement");

  let path = API_BASE_URL+glb_username+"/"+obj._id;
  if (obj.hyperlink !== undefined && obj.hyperlink != "")
  { path = obj.hyperlink }
  let thingsdatabaseowner = obj.hyperlink.split("/");
  thingsdatabaseowner = thingsdatabaseowner[thingsdatabaseowner.length-2];
  let isReturnToOwner = (thingsdatabaseowner === obj.inPossessionOf)
  let dataOut = {
    "data":
          [{
            "type":"handover_announce",
            "username":obj.inPossessionOf,
            "isReturn":isReturnToOwner
          }]
    }

  $.ajax({
    type: "POST",
    url: path,
    data: JSON.stringify(dataOut),
    success: callback,
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: callback,
    contentType:"application/json"
  });
}


</script>

<div data-role="page" id="borrow">

  <style>


    #borrow {
      background-color: #fff2cd;
    }

    #btn_send_item_request {
      background-color: #abcecc;
      text-shadow: none;
    }

    .borrow_footer {
      margin-left: -1em;
      padding: 10px;
      bottom: 0px;
      position: fixed;
      z-index: 99;
      background-color: #ff004c;
      color: #fff2cd !important;
      text-shadow: none;
    }

    .borrow_header {
      background-color: #abcecc;
      width: 100vw;
      padding: 5px;
      margin-left: -1em;
      margin-top: -1em;
    }

  </style>

  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
    <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content">
      <div class="borrow_header">
        <h2 align="center">CONTACT OWNERS OF ITEM</h2>
        <div align="center">
          You want to borrow the items below <br>
        </div>
      </div>
      <br>
      <b>from:</b>
      <input type="date" name="date" id="from" value=""  />
      <br>
      <b>till:</b>
      <input type="date" name="date" id="till" value=""  />
      <div class="borrow_footer">
        <hr>
        <span>
        <b>ATTENTION: If you send a BORROW request to its owners your contact details will be
        forwarded to the owner!</b> <br>(You can change these details anytime in the config menu)
        </span>
        <br>

        <button id="btn_send_item_request">SEND BORROW REQUEST</button>
        <hr>
      </div>


  </div>
  <!-- END CONTENT -->
</div>


<script>

$( document ).on( "pageshow", "#borrow", function(e,ui) {
    console.log(window.location.search);
    console.log("just loaded borrow");
    console.log(ui.prevPage);

    $("#handover .ui-content li").remove()

    for(value of collection.bulk)
    {
      $("#borrow .ui-content").append("<li>"+value.name)
    }
})

$("#btn_send_item_request").click(function(){

  let dataOut = {
    "data":
          [{
            "type":"borrow_request",
            "ref":collection.bulk[0].name,
            "from":$("#from").val(),
            "till":$("#till").val(),
            "contact_details":config.contact_details
          }]
  }
  let dbOwner = collection.bulk[0].hyperlink.split("/");
  dbOwner = dbOwner[dbOwner.length-2];
  console.log(dataOut);
  $.ajax({
    type: "POST",
    url: API_BASE_URL+dbOwner,
    data: JSON.stringify(dataOut),
    success: function(r){
      console.log("borrow request send");
      console.log(r);
      showToast("Borrow request send to "+dbOwner,1000);
      window.history.back();
    },
    xhrFields: { withCredentials: true }, // to make AuthCookie ok
    error: function(err){
      console.log("borrow request error");
      console.log(err);
      showToast("borrow request ERROR",800);
    },
    contentType:"application/json"
  });

})


</script>

<style>

#search {
  /*background-color: rgba(0, 159, 255, 0.38);*/
  background-color: #fff2cd;
  color: black;
  margin-bottom: 9vh;

}

#locationEditor_Search .ui-collapsible-content{
  background-color: #fff2cd;
  text-shadow: 0px 0px 0px black !important;
  width: 100%;
  margin-left:-1em;
  padding: 0 1em;
}

#locationEditor_Search #map{
  height: 20vh;
}

#locationEditor_Search .ui-collapsible-heading{
  display: none
}

#locationEditor_Search .ui-flipswitch{
  display: none
}

#locationEditor_Search .map_description_container{
  display: none
}

#locationEditor_Search .containerOf{
  display: none
}

#locationEditor_Search .btn_getlocation{
  height: 2.5em;
}

#locationEditor_Search table {
    font-size: 0.8em !important;
    line-height: 0.8em;
    margin: 0;
    padding: 0;
    border-spacing: 0px
}

.flex-container-row {
  display: flex;
  flex-direction: row;
  justify-content: space-around;
  align-items: center;
}
.halfwidth {
  width: 50%;
}
.thirdwidth {
  width: 33%;
}

.btn_addSearchTerm{
  width: 2em !important;
  height: 2em !important;
  text-align: center;
  align-items: center;
}

.searchTerm .ui-input-btn /* overwriting jquery button container*/
{
  width: 2em !important;
  padding: 0px !important;
  height: 2em !important;
}

.select-km-container{
  background-color: #a1d0c6;
  text-shadow: none;
  margin: 1em;
}

#searchTerms{

}

.searchTerm {
  background-color: #fde7a3;
  width: 90vw;
  margin-left: -1em;
  padding: 0em 1em;
}

.searchTerm input{
      max-width: 50vw;
      width: 50%;
}

.find_header {
    background-color: #abcec6;
    width: 100vw;
    margin-left: -1em;
    margin-top: -1em;
    /*height: 10vh;*/
    color: #fff2c9;
    text-shadow: none;
    align-items: center;
}

</style>

<div data-role="page" id="search">

  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content">

    <div class="find_header">
        <H1 align="center">FIND</H1>
    </div>
    <div id="searchTerms">
    <!--<div class="flex-container-row searchTerm">
        <input type="text" class="searchtext"></input>
        <span style="margin-left:5px">in</span>
        <div class="thirdwidth">
          <select class="select-searchField" data-mini="true">
            <option>name</option>
            <option>id</option>
            <option>tags</option>
            <option>owners</option>
          </select>
        </div>
        <button class="btn_addSearchTerm">+</button>
      </div>-->
    </div>

    <div class="flex-container-row select-km-container">
      <h3>within</h3>
      <div class="halfwidth">
        <select name="select-km" id="select-km" data-mini="false">
          <option value="0.5" selected="selected">500m</option>
          <option value="1">1km</option>
          <option value="2">2km</option>
          <option value="5">5km</option>
          <option value="10">10km</option>
          <option value="20">20km</option>
          <option value="42">42km</option>
          <!--<option value="50">50km</option>-->
          <!--<option value="100">100km</option>-->
        </select>
      </div>
      <h3>of</h3>
    </div>

    <div id="locationEditor_Search">

    </div>

    <div id="btn_search_public" class="btn_request ui-btn"
      style="height:10vh;width:100%;left:-1em;bottom:-1em;background-color:#ff004c!important;
      color:#fff2cd;z-index: 3;position:fixed;">
      SEARCH</div>

    </div>

    </div>

  </div>
  <!-- END CONTENT -->

</div>

<script>

  $( document ).on("pageshow", "#search", function(e,ui) {
    console.log("search loaded");

    // move locationContainer here and open it:
    $("#locationMoveable").appendTo("#locationEditor_Search");
    $("#locationEditor_Search").trigger("create");
    $("#locationMoveable").collapsible( "expand" );

    updateInsideOfFlipSwitch(false)
    //addSearchTermHandler()
    if (barcode.targetinput)
    {
      if (!barcode.targetinput.includes("#searchinput_"))
      {
        $("#searchTerms").html("");
      }
    }
    else {
      $("#searchTerms").html("");
    }

    appendSearchTerm();
  })



/**
gets all searchTerms from userinputs in textfields and dropdowns of search view
and combines them to mango queries for further processing
*/
  $("#btn_search_public").click(function(){
    makeSearch()
  })


  function makeSearch(db="public"){
    let searchTerm = getSearchTerms();
    let searchLocation = getSearchLocationAndKm();
    if(searchLocation)
    {
      searchAndShow(searchLocation[0],searchLocation[1],searchLocation[2],console.log,db,
                            searchTerm)
    }
    else {
      console.log("user did not provide geolocation");
    }

  }

  function getSearchTerms(){

    let searchTerms = $("#searchTerms").children();
    let searchFields = $('#searchTerms span.select-searchField');

    let selector = { "_id":{"$regex":""},"$and":[] }

    for (item of searchTerms){
      //console.log($(item).children()[3]);
      let searchField = $($(item).children()[3]).find("span.select-searchField").text()
      let searchText = $(item).children()[0].value

      let searchTerm = {};
      searchTerm[searchField] = { "$regex":"(?i)"+searchText}
      if (searchField === "owners" || searchField === "other.tags"){ // for arrays we have to check with $in
        searchTerm[searchField] = { "$in":[searchText]}
      }
      selector["$and"].push(searchTerm)

    }

    console.log(selector);
    return selector

  }

  function getSearchLocationAndKm(){
    let lat = parseFloat($('#latitude').val());
    let long = parseFloat($('#longitude').val());
    let km = parseFloat($('#select-km').val());
    console.log("searching within "+km+" kilometers");

    if (lat === "" || long === "" || (lat === 0 && long === 0) || !km)
    {
      swal({html:"you need to gimme geodata!"})
      return false;
    }
    else {
      console.log("no problems on the geofront");
      return [lat,long,km]
    }

  }

  function appendSearchTerm(){


    // get number of searchTerm:
    let num = $('#searchTerms').children().length;

    // atm only add a barcodebtn if not on ios (see barcode.mustache for reasons):
    let barcodebtn = `<img class="barcodebtn" src="./icons/barcode.png" onclick="scan('#searchinput_${num}')">`;
    if(navigator.userAgent.match(/(iPhone|iPod|iPad)/i))
    {
      barcodebtn=`<img hidden class="barcodebtn" src="./icons/barcode.png" onclick="scan('#searchinput_${num}')">`;
    }
    // Add a new div
    $(`
      <div class="flex-container-row searchTerm">
        <input id="searchinput_${num}" type="text" class="searchtext"></input>
        `
        +
        barcodebtn
        +
        `<span style="margin-left:5px">in</span>
        <div class="thirdwidth">
          <select id="select_${num}" class="select-searchField" data-mini="true">
            <option>name</option>
            <option>id</option>
            <option>other.tags</option>
            <option>owners</option>
          </select>
        </div>
        <button id="button_${num}" data-mini="true" class="btn_addSearchTerm">+</button>
      </div>
      `).appendTo('#searchTerms');
    // Add a new select element
    /*$('<select>').attr({'name':'select-choice-1','id':'select-choice-1'}).appendTo('');
    $('<option>').attr({'value':'1'}).html('Value 1').appendTo('#select-choice-1');
    $('<option>').attr({'value':'2'}).html('Value 2').appendTo('#select-choice-1');
    */
    // Enhance new select element
    $('#select_'+num).selectmenu();
    $('#button_'+num).button();
    addSearchTermHandler()
  }

 function addSearchTermHandler(){
   $(".btn_addSearchTerm").off("click");
   $(".btn_addSearchTerm").on("click",function(){

     appendSearchTerm();

     addSearchTermHandler()
   })
 }

  function searchAndShow(lat,long,km,callback=console.log,db=glb_username,
                        searchTerm={"_id":{"$regex":""}},bookmark=null)
  {
      // save in collection global to find again for bookmark usage
      collection.searchQuery = searchTerm;
      collection.searchDB = db;
      collection.latitude = lat;
      collection.longitude = long;
      collection.kilometers = km;

      let cb = function(result){
        callback(result)
        collection.bookmark = result.bookmark
        //if (collection.bookmark === "nil"){collection.bookmark = null}

        // change page to show the searchResults:
        $.mobile.changePage("#collection", {
           reloadPage: false
       });
       console.log("BOOKMARK: " + bookmark);
       if (bookmark === null){ // if this is the first query
         // render without catching first:
         console.log("first time is a charm");
         setNewCollectionSearchHistory(result.docs); // and start new history
         $("#loadingGif").show();
         $("#itemList .item").parent().remove();
         if (collection.searchDB === glb_username)
         { // if looking at users own collection: include borrowed items
          drawItemCards(result.docs,true,scrollEndListenerSearch)
         }
         else {
           drawItemCards(result.docs,false,scrollEndListenerSearch)
         }
         $("#no_items_left").html("  loading ...");
         $("#no_items_left").addClass("typing");
         $("#no_items_left").appendTo("#itemList");
       }
       else { // if this is a follow up query using a bookmark:
         collection.searchhistory[0].concat(result.docs)
         if (result.docs.length === 0) // was the last response empty?
         {
           console.log("END OF SEARCH ");
           // renderItemCards and add them instead of deleting the last ones but with no new scrollend:
           drawItemCards(result.docs,false,null,true)
           $("#scrollend").remove();
           setTimeout(function(){
             $("#no_items_left").html(" ... no more items");
             $("#no_items_left").appendTo("#itemList");
             $("#no_items_left").removeClass("typing");
             $("#no_items_left").show();
           },1000)

         }
         else {
           console.log("AND ANOTHER ONE....");
           $("#loadingGif").show();
           // renderItemCards and add them instead of deleting the last ones:
           drawItemCards(result.docs,false,scrollEndListenerSearch,true)
           $("#no_items_left").html("  loading ...");
           $("#no_items_left").addClass("typing");
           $("#no_items_left").appendTo("#itemList");

           setTimeout(function(){
             // then call eventhandler again in case scrollend is still in view (e.g. because too little items):
             if ($("#scrollend").length > 0) // should not be true after END OF SEARCH
             {
               scrollEndListenerSearch()
             }
           },1000)
         }

       }

      }

      if (collection.bookmark === "nil"){
        collection.bookmark = null;
        return;
      }
      if (db !== glb_username)
      {
        searchByKm(lat,long,km,cb,db,searchTerm,bookmark)
      }
      else
      {
        searchUserDB(cb,searchTerm,bookmark)
      }

  }

  function scrollEndListenerSearch()
  {
      if (isInView("#scrollend") && window.location.hash.includes("#collection"))
      {
        $("#no_items_left").show()
        $("#scrollend").remove();
        document.removeEventListener("scroll",scrollEndListenerSearch);
        console.log("scrollend reached! triggering callback to scrollend...");

        //load again with bookmark included and add instead of overwrite:
        searchAndShow(collection.latitude,collection.longitude,collection.kilometers,
          console.log,collection.searchDB,collection.searchQuery,collection.bookmark)

      }
  }

  function searchByKm(lat,long,km,callback=console.log,db=glb_username,
                      searchTerm={"_id":{"$regex":""}},bookmark=null)
  {
    let bounds = getBoundingBoxAroundGeoCoordByDistance(lat,long,km);
    searchByBoundingBox(bounds.lowerLeftCorner,bounds.upperRightCorner,
                                          callback,db,searchTerm,bookmark)
  }


  function searchByBoundingBox(lowerLeftCorner,upperRightCorner,callback=console.log,
                      db=glb_username,searchTerm={"_id":{"$regex":""}},bookmark=null)
  {
    // build selector and add borders of the bounding box
    let selector = {
      "location.latitude": {
         "$gte": lowerLeftCorner[0]
      },
      "$and": [
         {
            "location.longitude": {
               "$gte": lowerLeftCorner[1]
            }
         },
         {
            "location.latitude": {
               "$lte": upperRightCorner[0]
            }
         },
         {
            "location.longitude": {
               "$lte": upperRightCorner[1]
            }
         },
         {
            "owners":{
              "$nin": [glb_username] // exclude users own items from search results TODO: make this work with hyperlink
            }
         }
      ]
   }
   // add original searchTerm to selector:
   selector["$and"].push(searchTerm)

    $.ajax({
      type: "POST",
      url: API_BASE_URL,
      data: JSON.stringify({
            	"data":
              [{
            		"type":"search",
                "db": db,
            		"doc":selector,
                "bookmark":bookmark
            	}]
            }),
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      success: function(result){
         callback(result)
         //console.log(result);
      },
      error: console.log,
      contentType:"application/json"
    });

  }


  function searchUserDB(callback=console.log,searchTerm={"_id":{"$regex":""}},bookmark=null)
  {
    // build selector and exclude all items with -containerOf; Ampersand or config_one in _id:
      let selector = {
        "_id": {
           "$not": {
              "$regex": "-containerOf"
           }
        },
        "$and": [
           {
              "_id":{
                  "$not": {
                     "$regex": "&|config_one"
                  }
                }
           }
        ]
     }
     // add original searchTerm to selector:
     selector["$and"].push(searchTerm)

     console.log("searching userDB");
     console.log(glb_username);
     console.log(selector);
     console.log(bookmark);

      $.ajax({
        type: "POST",
        url: API_BASE_URL,
        data: JSON.stringify({
              	"data":
                [{
              		"type":"search",
                  "db": glb_username,
              		"doc":selector,
                  "bookmark":bookmark
              	}]
              }),
        xhrFields: { withCredentials: true }, // to make AuthCookie ok
        success: function(result){
           callback(result)
           //console.log(result);
        },
        error: console.log,
        contentType:"application/json"
     });

  }


  /**
  helper function. calculates new geocoordinates (latitude, longitude) from
  input geoposition and the distances from it, provided in km
  */
  function latLongPlusKm(latitude,longitude,distancekmLat,distancekmLong)
  {
    let earthRadius = 6378;
    let newlat = latitude+(distancekmLat / earthRadius)*(180/Math.PI);
    let newlong = longitude+(distancekmLong / earthRadius)*(180/Math.PI)/Math.cos(latitude*Math.PI/180);

    return [newlat,newlong];
  }

  /**
  returns an object containing the fields "upperRightCorner" and "lowerLeftCorner"
  (each an array of latitude and longitude in decimal) containing the information
  needed for a bounding box around a geographic point defined by latitude and longitude.
  It uses distancekm to calculate the edges.
  */
  function getBoundingBoxAroundGeoCoordByDistance(latitude,longitude,distancekm){

    // edges of boundingBox:
    let upperRightCorner = latLongPlusKm(latitude,longitude,distancekm,distancekm)
    let lowerLeftCorner = latLongPlusKm(latitude,longitude,-distancekm,-distancekm)

    return {upperRightCorner:upperRightCorner,lowerLeftCorner:lowerLeftCorner}
  }

  /**
  helper function. checks if latitude and longitude are within a bounding box
  defined by lowerLeftCorner and upperRightCorner coordinate arrays

  not actually used, because these calculations are done through the searchquery.
  but good to have. And to copy from

  @returns {boolean} true if is within the bounds of the box.
  */
  function isInsideBoundingBox(latTest,longTest,lowerLeftCorner,upperRightCorner)
  {
    if (latTest > lowerLeftCorner[0] && latTest < upperRightCorner[0] &&
        longTest > lowerLeftCorner[1] && longTest < upperRightCorner[1])
        {
          return true
        }
    return false
  }

</script>


<link rel="stylesheet" href="assets/handsontable.full.css">
<style>

  #table .ui-content{
    overflow: scroll
  }

  .handsontable table {
    font-size: 0.8em;
  }
  .handsontable th {
    white-space: normal !important;*/
    word-wrap: break-word;
    vertical-align: middle;
  }

  input[type="checkbox"] {
      display:none;
  }
  input[type="checkbox"] + label {
      font-family: sans-serif;
      font-size: 0.8em
  }
  input[type="checkbox"] + label span {
      display:inline-block;
      width:19px;
      height:19px;
      margin:-2px 2px 0 20px;
      vertical-align:middle;
      background:url(check_sheet.png) left top no-repeat;
      cursor:pointer;
      transform: scale(1.1,1.1);
  }
  input[type="checkbox"]:checked + label span {
      background:url(check_sheet.png) -19px top no-repeat;
  }

  #exampleConsole {
      margin-left: 20px;
      color: green;
  }

  .greyfont {
    color: lightgrey !important
  }

  #loadData {
    max-width: 33vw;
    background-color: rgba(225,225,255,1);
    white-space: normal;
    /*display: none*/
  }

  .tablebutton {
    font-size: 1.5vh;
    height: 5em;
  }

  #saveData {
    max-width: 33vw;
    background-color: rgba(255,205,205,1);
    white-space: normal;
    text-shadow: none
  }

  #autosave {
    max-width: 20vw;
    text-shadow: none
  }

  .invisible {
    opacity: 0;
    pointer-events: none;
  }

  .buttonrow {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }

  #tablemain .ui-checkbox .ui-btn{
    /*height: 100%;*/
    white-space: nowrap;
  }

  @media screen and (min-width:1092px)
  {
    .tablebutton {
      height: 2.5em
    }

    #tablemain .ui-checkbox .ui-btn{
      height: 0.7em;
    }



  }


</style>

<div data-role="page" id="table">

  <!-- HEADER TEMPLATE -->

<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
  <!-- END HEADER -->

  <!-- CONTENT -->
  <div role="main" class="ui-content" id="tablemain">

    <div class="buttonrow">
      <button id="loadData" class="tablebutton">load data from server</button>
      <button id="saveData" class="tablebutton">save data to server</button>
      <input type="checkbox" id="autosave" class="tablebutton"/>
      <label for="autosave"><span></span>autosave on</label>
      <span id="exampleConsole"></span>
    </div>

    <br>
    <div id="example"></div>

  </div>
  <!-- END CONTENT -->

</div>

<script src="assets/handsontable.full.js" type="text/javascript"></script>
<script src="assets/xlsx.full.min.js" type="text/javascript"></script>
<!--needed for xlsx dl-->
<script src="assets/FileSaver.min.js" type="text/javascript"></script>
<script src="assets/dotize.js" type="text/javascript"></script>

<script>

  let table = {
  }

  let dataObject = [];
  let hot = hot_init();


  $( document ).on("pageshow", "#table", function(e,ui) {
    if (dataObject.length <= 1)
    {
      loadAllItems().then(function(res){
        console.log(res);
        filltable(res,true);
      })
    }
    else {
      hot = hot_init()
    }

  })

  $( window ).resize(function() {
    hot = hot_init()
  });

  document.getElementById("loadData").addEventListener("click",function(){
    loadAllItems().then(function(res){
      console.log(res);
      filltable(res,true);
    })
  })

  $("#autosave").change(function(){
    if ($('#autosave:checkbox:checked').length > 0)
    {
      swal({
        html:`Vorsicht!<br><br> Ab jetzt wird jede Änderung in der Tabelle
        sofort hochgeladen.<br> Da machst du schnell was kaputt. Mach vorsichtig!`
      })
    }
  })

  $("#saveData").click(function(){

    $(exampleConsole).removeClass("greyfont")
    exampleConsole.innerText ='saving all items to database....';

    $("#saveData").addClass("invisible")

    saveAllItems()
    .then(function(){

      $(exampleConsole).addClass("greyfont")
      exampleConsole.innerText ='all up to date';
      console.log("items saved");
      console.log("reloading table");

      loadAllItems()
      .then(function(res){

        filltable(res);
        $("#saveData").removeClass("invisible")

      })
    })

  })


  /**
  */
  function loadAllItems(){

      console.log("loading all items");
      return new Promise(function(resolve, reject) {

        $.ajax({
          type: "GET",
          url: API_BASE_URL + glb_username+"/_all_docs",
          xhrFields: { withCredentials: true }, // to make AuthCookie ok
          success: function(r){
            promiseArray = [];
            if (r.rows)
            {
              r.rows.forEach(function(row){
                //console.log(row);
                if (row.id && !row.id.includes("-containerOf")
                    && !row.id.includes("&") && !row.id.includes("_design"))
                {
                    promiseArray.push(new Promise(
                        function(reso,reje){
                          getSingleItem(row.id,function(item){reso(item)})
                        }
                      )
                    )
                }

              })
              resolve(Promise.all(promiseArray))
            }
          },
          error: function(err){reject(err)},
          contentType:"application/json"
        });

      });
  }

  /**
  returns promise that resolves after all DB updates have been processed
  */
  function saveAllItems(){ // continue here

        console.log("saving!");

        let promiseArray = [];

        for (i in dataObject)
        {
          let promise = new Promise(function(reso,reje) {
            if (dataObject[i]._id && dataObject[i]._id !== "")
            {
              let j = i; // scope shizzle
              let item = JSON.parse(JSON.stringify(dataObject[j]))
              setTimeout(function(){
                item = convertItemToItemWithArrays(item);
                updateOverwrite(item,function(res){
                  console.log(res);
                  console.log(j);
                  if (res.ok)
                  {
                    dataObject[j]._rev = res.rev
                  }
                  reso(res)
                },function(res){ // in case we have an conflict error, try again once in a second:
                  /*
                  FIXME: This is NOT an optiomal solution. But we will stick with it
                  until we have a state machine option build into dingsdas API at server.js
                  */

                  if(res.status && res.status.toString().startsWith("409")) { console.log("conflict"); }
                  else if(res.status &&  res.status.toString().startsWith("500")) { console.log("server error"); }
                  else if(res.status && res.status.toString().startsWith("4")) { console.log("other error"); }

                  setTimeout(
                    function(){
                      updateOverwrite(item,function(res){
                          console.log(res);
                          console.log(j);
                          if (res.ok)
                          {
                            dataObject[j]._rev = res.rev
                          }
                          reso(res)
                        },
                        function(err){
                          if(err.status && err.status.toString().startsWith("409")) { console.log("conflict"); }
                          else if(err.status && err.status.toString().startsWith("500")) { console.log("server error"); }
                          else if(err.status && err.status.toString().startsWith("4")) { console.log("other error"); }
                          alert("item with _id: "+item._id+"\n("+item.name+")\ncould not be updated.");
                          console.log(res);
                          reje("err")
                        }
                        )
                  }
                    ,1000)
                });
              },0)
            }
            else if (dataObject[i].name && dataObject[i].location !== undefined)
            {
              dataObject[i] = addOwners2DocIfNoOwners(dataObject[i]);
              addNewItemFromTable(dataObject[i],i,function(){ reso("aha") })
            }
            else {
              reso("nothing")
            }
          }) // micro promises
        promiseArray.push(promise)
        } // end for loop

      console.log(promiseArray);
      return new Promise(function(resolve, reject) {

        Promise.all(promiseArray)
          .then(()=>{resolve("done")})
          .catch((err) => {reject("could not finish saveAllItems()")})

      }) // end main promise

  }


    function hot_init() {
      let container = document.getElementById('example');
      return new Handsontable(container, {
        /*beforeRender*/
        beforeInit: function(){
          console.log("init hot");
            for (doc of dataObject)
            {
              if (!doc.owners){return}
              delete doc._attachments;
              doc.owners = doc.owners.toString();
              if (doc.other && doc.other.tags){
                doc.other.tags = doc.other.tags.toString();
              }
              //doc.other.visibility = doc.other.visibility.toString();
            }
        },
        data: dataObject,
        height:function(){
          let screenheight = window.innerHeight
            || document.documentElement.clientHeight
            || document.body.clientHeight;
          let size = screenheight*0.65;
          if(!isOnMobile()){
            //console.log("!!!!! DESKTOP !!!!!!");
            size = screenheight*0.75;
          }
          //console.log(size);
          return size
        },
        columns: [{
                    data: "_id",
                    width: 50,
                    wordWrap:false
                  }, {
                    data: "name",
                  }, {
                    data: "other.description",
                    width: 200,
                  }, {
                    data: "other.count",
                    width: 60
                  }, {
                    data: "other.weight",
                    width: 60
                  }, {
                    data: "other.value",
                    width: 60
                  },{
                    data: "other.tags",
                    width: 120
                  },{
                    data: "location.description",
                    width: 80,
                    wordWrap:false
                  }, {
                    data: "location.address",
                    width: 200,
                    wordWrap:false
                  }, {
                    data: "location.latitude",
                    width: 50,
                    wordWrap:false
                  }, {
                    data: "location.longitude",
                    width: 50,
                    wordWrap:false
                  },{
                    data: "location.insideOf",
                    wordWrap:false,
                    width: 120
                  }, {
                    data: "other.madein",
                    width: 60
                  }],
        colHeaders: ["ID","Name","Description","Number of pieces","Weight","Price",
          "tags / keywords","Location .description","Location .address",
          "Location .latitude","Location .longitude","InsideOf item with ID",
          "Country of origin"],
        rowHeaders: true,
        minSpareRows: 1,
        autoWrapRow: true,
        manualRowResize: true,
        manualColumnResize: true,
        contextMenu:{
          items:{
            "export_carnet_csv": { // Own custom option
              name: 'export as Carnet.csv',
              callback: function(inp,test) { // Callback for specific option
                setTimeout(function() {
                  console.log(hot.getSelected()); // Fire alert after menu close (with timeout)
                  // here get all selected rows._id s and then build carnet from it
                  let carnetArrayNumbered = getCarnetFromRows(hot.getSelected())
                  renderCarnetATAcsv(carnetArrayNumbered); //works
                }, 0);
              }
            },
            "export_carnet_xls": { // Own custom option
              name: 'export as Carnet.xls',
              callback: function(inp,test) { // Callback for specific option
                setTimeout(function() {
                  console.log(hot.getSelected()); // Fire alert after menu close (with timeout)
                  // here get all selected rows._id s and then build carnet from it
                  let carnetArrayNumbered = getCarnetFromRows(hot.getSelected())
                  renderCarnetATAexcel(carnetArrayNumbered); //DOES IT WORK???
                }, 0);
              }
            },
            "export_carnet_pdf": { // Own custom option
              name: 'export as Carnet.pdf',
              callback: function(inp,test) { // Callback for specific option
                setTimeout(function() {
                  console.log(hot.getSelected()); // Fire alert after menu close (with timeout)
                  // here get all selected rows._id s and then build carnet from it
                  let carnetArrayNumbered = getCarnetFromRows(hot.getSelected())
                  renderCarnetATApdf(carnetArrayNumbered) // works
                }, 0);
              }
            },
            "sep1": {name: '---------'},
            "export_verwendungsnachweis_csv": { // Own custom option
              name: 'export as Verwendungsnachweis.csv',
              callback: function(inp,test) { // Callback for specific option
                setTimeout(function() {
                  console.log(hot.getSelected()); // Fire alert after menu close (with timeout)
                  let array = getVerwendungsNachweisArray(hot.getSelected());
                  for (i in array)
                  {
                    array[i]=Object.values(array[i])
                    console.log(array[i]);
                  }
                  console.log(array);
                  renderCSV(["Datum","BelegNr","Empfänger*in/Einzahler*in",
                    "Warenbezeichnung inkl. Seriennummer","Einkaufspreis EUR",],
                    array,"Verwendungsnachweis.csv",true)
                }, 0);
              }
            },
            "export_verwendungsnachweis_xls": { // Own custom option
              name: 'export as Verwendungsnachweis.xls',
              callback: function(inp,test) { // Callback for specific option
                setTimeout(function() {
                  console.log(hot.getSelected()); // Fire alert after menu close (with timeout)
                  let array = getVerwendungsNachweisArray(hot.getSelected());
                  for (i in array)
                  {
                    array[i]=Object.values(array[i])
                    console.log(array[i]);
                  }
                  console.log(objToArray(array));
                  array = objToArray(array);
                  array.unshift(["Datum","BelegNr","Empfänger*in/Einzahler*in",
                    "Warenbezeichnung inkl. Seriennummer","Einkaufspreis EUR",])
                  renderAndDownloadExcel(array,[10,7,10,40,10])
                }, 0);
              }
            },
            "sep2": {name: '---------'},
            "export_table_xls": { // Own custom option       // CONTINUE HERE !!!!!!!!!!!!!!!!!!!
              name: 'export complete table as xls',
              callback: function(inp,test) { // Callback for specific option
                setTimeout(function() {

                  console.log(hot.getSourceData());
                  let array = JSON.parse(JSON.stringify(hot.getSourceData()));
                  for (i in array)
                  {
                    array[i]=dotize.convert(array[i])
                    console.log(array[i]);
                  }
                  //console.log(objToArray(array,true));
                  array = objToArray(array,true); // make into array of arrays
                  console.log(array);
                  renderAndDownloadExcel(array,[1,1,30,10,10,10,10,10,10,10,30,10,10,10,10])
                }, 0);
              }
            },
            "sep22":{name: '---------'},
            "row_above":{},
            "row_below":{},
            "remove_row":{},
            "sep3": {name: '---------'},
            "alignment":{},
            "make_read_only":{},
          }
        },
        cells: function (row, col, prop)
        {
          let cellProperties = {}

          if ( ["_id","id","containerOf","hyperlink"].includes(prop) )
          {
            cellProperties.readOnly = true;
          }
          return cellProperties;
        },
        afterChange: function (change, source) {
          let autosave = document.getElementById("autosave");
          let exampleConsole = document.getElementById("exampleConsole");
          if (source === 'loadData') {
            return; //don't save this change
          }
          if (!autosave.checked) {
            return;
          }
          // timeouts purely cosmetic...
          clearTimeout(autosaveNotification);
          var autosaveNotification = setTimeout(function() {
                $(exampleConsole).removeClass("greyfont")
                exampleConsole.innerText ='Changes will be autosaved...';
                console.log("Changes will be autosaved");
                saveChangesToServer(change)
                .then(function(){
                  setTimeout(function(){
                    $(exampleConsole).addClass("greyfont")
                    exampleConsole.innerText ='all up to date';
                  },500)
                })
              }, 100);
        },
        beforeRemoveRow: function(start,count){
          console.log(start);
          console.log(count);
          // get items:
          let items = [];
          for (let i=start; i < start+count; i++)
          {
            items.push(dataObject[i])
          }
          console.log(items);

          swal({
              title:"DELETE ROW(S)?",
              html:`Willst du die gerade entfernte(n)
                items auch auf dem Server löschen?`,
                showCancelButton: true,
                focusConfirm: false,

          }).then((result) => {
            if (result.value) {
              // TO DO: delete ITEMS via dingsda API!!!
              for (var i = 0; i < items.length; i++) {
                removeit(items[i]._id)
              }
              Swal(
                'Deleted!',
                'items wurden gelöscht.',
                'success'
              )
            }
          })
        }

      });
    }

    /**
    */
    function getAllMarkedRows(chosen)
    {
      let data = []
      for (var i in chosen)
      {
        let rows = chosen[i];
        rows = [rows[0],rows[2]];
        rows.sort(function(a, b){return a-b}); // sort array
        //console.log(rows);
        for (var j = rows[0]; j <= rows[1]; j++)
        {
          //console.log(dataObject[j]._id);
          addToArrayIfNotExist(data,j)
        }
      }
      console.log(data);
      return data
    }

    /**
    */
    function getVerwendungsNachweisArray(chosen)
    {
      let rows = getAllMarkedRows(chosen)

      let nachweisArray = []
      // prepare data for Carnet export:
      for (i of rows)
      {
        // default rimini to exist as emtpy object if undefined:
        dataObject[i].other.rimini = dataObject[i].other.rimini || {};
        console.log(dataObject[i]);
        let item = {}
        Object.assign(item, {
          receiptDate:dataObject[i].other.rimini.receiptDate,
          receiptNo:dataObject[i].other.rimini.receiptNo,
          boughtAt:dataObject[i].other.rimini.boughtAt,
          description : dataObject[i].name,
          price: dataObject[i].other.rimini.priceNew,
        });
        if (item.receiptDate === undefined){ item.receiptDate = "";}
        if (item.receiptNo === undefined){ item.receiptNo = "";}
        if (item.boughtAt === undefined){ item.boughtAt = "";}
        if (item.description === undefined){ item.description = " ";}
        if (item.price === undefined){ item.price = "";}
        nachweisArray.push(item);
      }
      console.log(nachweisArray);
      return nachweisArray;
    }

    /**
    */
    function getCarnetFromRows(chosen)
    {
      let rows = getAllMarkedRows(chosen)

      let carnetArray = []
      // prepare data for Carnet export:
      for (i of rows)
      {
        console.log(dataObject[i]);
        let item = {}
        Object.assign(item, {
          description:dataObject[i].name,
          count : dataObject[i].other.count,
          origin : dataObject[i].other.madein,
          price : dataObject[i].other.value,
          weight : dataObject[i].other.weight,
        });
        if (item.count === undefined){ item.count = "1";}
        if (item.origin === undefined){ item.origin = "";}
        if (item.price === undefined){ item.price = "";}
        if (item.weight === undefined){ item.weight = "";}
        carnetArray.push(item);
      }
      console.log(carnetArray);
      let carnetArrayNumbered = numberItems(carnetArray);
      console.log(carnetArrayNumbered);

      return carnetArrayNumbered;
    }

    /**
    renders CarnetATA from tableview as CSV using renderCSV()
    */
    function renderCarnetATAcsv(array)
    {
      let header = ["no","description","count","weight","price","origin"]
      renderCSV(header,array,"carnetATA.csv")
    }

    /**
    */
    function renderCarnetATAexcel(array)
    {
      let header = ["count","description","no","origin","price","weight"]
      console.log(objToArray(array));
      array = objToArray(array);
      array.unshift(header)
      renderAndDownloadExcel(array,[5,30,3,8,8,8])
    }


    /**
    only flat objects. so need to dotize first.
    */
    function objToArray(input,fillEmptyFields=false,dotizeObjects=false){

      let output;

      if (fillEmptyFields){
        // first: get all keys used in this array of objects
        let keys = []
        input.forEach(function(obj) {
          // add keys to collection of keys
          Object.keys(obj).forEach((key)=>{
            addToArrayIfNotExist(keys,key)
          });
          //console.log(keys);
          // second: assign every key as header line of an array of arrays:
          output = [keys]
          console.log(output);
        })
        /* third: iterate throug input array of objects and fill the columns
        of the output array of array accordingly:*/
        let rows = input.map(function(obj){
            //console.log(obj);
            out = output[0].map((key)=>{
              //console.log(key);
              return obj[key]
            })
            console.log(out);
            return out
          })
        console.log(rows);
        output = output.concat(rows)
        return output;

      }
      else {

        output = input.map(function(obj) {

          if(dotizeObjects)
          {
            obj = dotize.convert(obj)
          }

          return Object.keys(obj).sort().map(function(key) {
            return obj[key];
          });
        });

        return output
      }

    }


    /**
    */
    function renderCSV(header,array,filename="download.csv",inputIsArrayOfArrays=false)
    {
      let output = "";
      output += header + "\n";
      if (!inputIsArrayOfArrays)
      {
        for (i in array){
          for (j in header)
          {
            output += array[i][header[j]]+","
          }
          output = output.slice(0,-1)
          output += "\n"
        }
      }
      else {
        for (i in array){
          for (j in array[i])
          {
            output += array[i][j]+","
          }
          output = output.slice(0,-1)
          output += "\n"
        }
      }

      console.log(output);
      var a         = document.createElement('a');
      a.download    = filename;
      a.href        = 'data:attachment/csv,' +  encodeURIComponent(output);
      a.target      = '_blank';

      document.body.appendChild(a);
      a.click();
    }

    /**
    */
    function addOwners2DocIfNoOwners(doc)
    {
      if (!doc.owners)
      {
          doc.owners = [glb_username]
      }
      return doc
    }



    /**
    saves changes in table row by row to the database. <br>
    uses from handsontable change event to find rows that have been updated, checks
    if _id provided. Adds as new item if not, updates if provided.

    @param {object} change - change object from handsontable
    */
    function saveChangesToServer(change)
    {
      return new Promise(function(resolve, reject) {


        console.log(change);
        console.log("saving to server from changes");
        let updatedRowNums = [];
        for (i in change)
        {
          //console.log(change[i]);
          addToArrayIfNotExist(updatedRowNums,change[i][0])
        }
        console.log("updateing rows: "+updatedRowNums);
        // now update all the items on their own:
        let updPromises = [];

        for (num of updatedRowNums){
          console.log(`updating row #${num}`);
          let item2Upd = JSON.parse(JSON.stringify(dataObject[num]));
          if (!item2Upd._id || item2Upd._id === undefined || item2Upd._id === ""){
            console.log("adding new ITEM");
            item2Upd = addOwners2DocIfNoOwners(item2Upd);

            addNewItemFromTable(item2Upd,num,function(r){resolve(r)})
          }
          else{
            item2Upd = convertItemToItemWithArrays(item2Upd);
            console.log(item2Upd);
            updateOverwrite(item2Upd,function(res){
              console.log(res);
              if (res.ok)
              {
                dataObject[num]._rev = res.rev
                resolve(res.rev)
              }
              else {
                if(res.status.toString().startsWith("409")) { console.log("conflict"); }
                else if(res.status.toString().startsWith("500")) { console.log("server error"); }
                else if(res.status.toString().startsWith("4")) { console.log("other error"); }
                alert("item with _id: "+item2Upd._id+"\n("+item2Upd.name+")\ncould not be updated.");
                console.log(res);
                reject("item with _id: "+item2Upd._id+"\n("+item2Upd.name+")\ncould not be updated.")
              }
            });
          }

        }



      })

    }

    /**
    helper function for tableview. Splits some fields of an object and turns
    lists of strings with commas into arrays of strings by splitting the strings
    at the commas
    */
    function convertItemToItemWithArrays(item2Upd)
    {
      if (item2Upd.owners && !Array.isArray(item2Upd.owners)){ item2Upd.owners = item2Upd.owners.replace(' ', '').split(",") }
      if (item2Upd.other && item2Upd.other.tags && !Array.isArray(item2Upd.other.tags)){item2Upd.other.tags = item2Upd.other.tags.split(",");}
      //if (!Array.isArray(item2Upd.visibility)){ item2Upd.visibility = item2Upd.visibility.replace(' ', '').split(",") }
      return item2Upd
    }

    /**
    */
    function addNewItemFromTable(item2Upd,rowNum,cb=console.log)
    {
      if (!(item2Upd.name && item2Upd.owners && item2Upd.location &&
          (item2Upd.location.address || item2Upd.location.latitude ||
          item2Upd.location.description)))
      {
        console.log("not adding cause sth missing");
        return
      }
      console.log("adding it");
      if (item2Upd.other){
        item2Upd.other.visibility = ["friends"];
      }
      else {
        item2Upd.other = { visibility : ["friends"] }
      }

      //return
      addit(item2Upd,function(res){
        console.log(res);
        if (res.ok)
        {
          getSingleItem(res.id,function(res2){
            dataObject[rowNum] = res2;
            hot.render();
            cb("done")
          }), function(err){
            throw err
          }
        }
        else {
          throw res
        }
      })

    }

    /**
    */
    function filltable(data,clearTable=true){
      if(clearTable)
      {
        dataObject = data;
      }
      else {
        dataObject = dataObject.concat(data)
      }
      hot.loadData(dataObject); // fill it into table
    }

    /**
    */
    function addToArrayIfNotExist(array,item){
      array.indexOf(item) === -1 ? array.push(item) : null/*console.log("item already exists")*/;
      return array;
    }

    /**
    */
    function moveInsideArray( array, originalIndex, newIndex ) {
      if ( newIndex >= array.length ) {
          var i = newIndex - array.length + 1;
          while (i--) {
              array.push( undefined );
          }
      }
      array.splice( newIndex, 0, array.splice( originalIndex, 1 )[0] );
    };

/* // exists inside addNew.mustache
    function addit(obj,callback=console.log)
    {
      let data = {
                "data":[{
                  "type":"addItems",
                  "doc":obj,
                }]
              };

      console.log("attempting to add item to dingsda");
      postAPI({
          path:glb_username,
          data:data,
           callback: function(result){
            callback(result)
          }

      });

    }
*/

    /**
    */
    function updateOverwrite(obj,callback=console.log,error=console.log)
    {
      if (!obj._id){return error("no _id provided")}
      console.log("trying to fetch originalObject from DB");
      console.log(obj);

      let path = API_BASE_URL+glb_username+"/"+obj._id;
      if (obj.hyperlink !== undefined && obj.hyperlink != "")
      { path = obj.hyperlink }

      getSingleItem(path, function(res){
          console.log("old and new obj:");
          console.log(res);
          //console.log("merging oldObj and formContents");
          let newObj = Object.assign({}, res, obj);
          /*
          in order to overwrite _rev in case in the time in between sb updated
          that item (not optimal but okay).
          */
          newObj._rev = res._rev;
          console.log(newObj);
          //console.log("attempting update of object");

          let newdata = {
              "data":[{
                "type":"update",
                "doc":newObj,
                //pic:document.getElementById("preview_photo").src
                //"doc":{_id:"33","other.visibility":["friends"]}
              }]
            }
            let reloadAfterUpdate = false;
            // photo upload:
            /*if (document.getElementById("addPhoto").src.startsWith("data:image/jpeg;base64") )
            {
              console.log("PIC added to newdata!!!");
              newdata.data[0].pic = document.getElementById("addPhoto").src;

            }*/
            //console.log(newdata);
            // write into DB
            $.ajax({
              type: "POST",
              url: path,
              data: JSON.stringify(newdata),
              success: function(res){
                callback(res)
              },
              xhrFields: { withCredentials: true }, // to make AuthCookie ok
              error: error,
              contentType:"application/json"
            });
        },
        function(err){callback(err)}
      )

    }
/* exists already inside addNew.mustache
    function postAPI({path="", data =null, callback=console.log,
                      error=function(err)
                      {;
                      console.log(err.responseText);
                      callback(err)
                    }})
    {

      $.ajax({
        type: "POST",
        url: API_BASE_URL+path,
        data: JSON.stringify(data),
        success: callback,
        xhrFields: { withCredentials: true }, // to make AuthCookie ok
        error: error
        ,contentType:"application/json"
      });

    }
*/
/* //exists already inside itemDetails.mustache
    function getSingleItem(id,callback,error=console.log)
    {
        // transform id into hyperlink in case no hyperlink was passed:
        if (!id.startsWith("https")){
          id = API_BASE_URL+glb_username+"/"+id;
        }
        console.log("fetching single Item: "+id);
        // get item json from DB
        $.ajax({
          type: "GET",
          url: id,
          success: callback,
          xhrFields: { withCredentials: true }, // to make AuthCookie ok
          error: error,
          contentType:"application/json"
        });

    }
*/
/** // exists inside collection.mustache
    function removeit(id, callbackdel=console.log)
    {
      console.log("removeit function triggered!!!");
      if (id == "" || id == undefined)
      {
        return
      }

      console.log("trying to fetch originalObject from DB");

      getAPI({
        path:glb_username+"/"+id,
        data:{
          "data":[{
            "type":"fetch"
          }]
        },
        callback: function(res){

          console.log(res);
          console.log("attempting DELETE of object");

          let deletedata = {
              "data":[{
                "type":"deleteItems",
                "doc":res,
              }]
            }

          postAPI({
              path:glb_username+"/"+id,
              data:deletedata,
                callback: function(result){
                callbackdel(result)
                console.log("DELETED "+id+" successfully");
                console.log(result);
              },
              error: function(err){
                console.log("error in deleteit delete");
                callbackdel(err)
              }

          });
        },
        error: function(err){
          console.log("error in deleteit prefetch");
          callbackdel(err)
        }
      })

    }
*/
/* exists inside addNew.mustache
    function getAPI({path="", data=null, callback=console.log, error=function(err)
                      {console.log(err.responseText)}})
    {

      $.ajax({
        type: "GET",
        url: API_BASE_URL+path,
        data: data,
        success: callback,
        xhrFields: { withCredentials: true }, // to make AuthCookie ok
        error: error
        //,dataType: "application/json"
        ,contentType:"application/json"
      });

    }
*/

    /**
    */
    function renderAndDownloadExcel( ws_data = [['empty','data']],
          columnwidths = [10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]
         )
    {
      let wb = XLSX.utils.book_new();
      wb.SheetNames.push("1");
      let ws = XLSX.utils.aoa_to_sheet(ws_data);

      // sets the width of the cols
      let wscols = [];
      for (i in columnwidths)
      {
        wscols.push({wch:columnwidths[i]})
      }
      ws['!cols'] = wscols;

      wb.Sheets["1"] = ws;
      let out = XLSX.write(wb, {bookType:'xlsx',  type: 'binary'});

      saveAs(new Blob([makeSpreadSheetBuffer(out)],{type:"application/octet-stream"}), 'test.xlsx');
    }

    /**
    */
    function makeSpreadSheetBuffer(inp)
    {
        let buffer = new ArrayBuffer(inp.length);
        let UintArray = new Uint8Array(buffer);
        for (var i = 0; i < inp.length; i++) UintArray[i] = inp.charCodeAt(i) & 0xFF;
        return buffer;
    }

    /**
    helper function. checking if running on desktop browser or mobile device
    */
    function isOnMobile() {

      let isMobile = false;
      (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i
      .test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
      return isMobile;
    }


</script>

<!--<script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>-->

<div data-role="page" id="barcode" data-dialog="true">

  <style>
  #barcode {
    background-color: rgba(0,0,0,0.1)
  }

  .overlay__content video {
      width: 100%;
      height: 100%;
  }

  .overlay__content canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      left: 0;
      top: 0;
  }

  #barcodeviewport.viewport {
      position: relative;
  }

  #barcodeviewport.viewport > canvas, #barcodeviewport.viewport > video {
      max-width: 100%;
      width: 100%;
      top: 0;
  }

  canvas.drawing, canvas.drawingBuffer {
      position: absolute;
      left: 0;
      top: 0;
      border: 1px green solid;
  }

  </style>

  <!-- HEADER TEMPLATE -->
<!--  
<div data-role="header" data-position="fixed" class="header">
  <div data-role="navbar" class="ui-state-persist">
    <ul>
    <li><a href="#config"><img id="config_icon" src="icons/gear.png" width=30px
      alt="config icon"></img>
    <span class="badge"></span></a></li>
    <li><a onclick=showNotifications()><img class="notifications_icon"
      src="icons/bell.png" width=30px alt="notifications icon">
      <span class="notifications_badge badge">0</span></a></li>
    <li><a href="#landing"><img id="location_icon" src="icons/dingsda.png"
      width=30px alt="start side icon">
    <span class="badge"></span></a></li>
    <li><a href="#collection" class="btn_collection" onclick="btn_collection_clicked();">
      <img class="collection_icon" src="icons/box2.png" width=30px alt="my collection icon">

      <span class="badge borrowedthings">0</span>
      <span class="badge collection_badge">0</span>
    </a></li>

    </ul>
  </div>
</div>
-->
  <!-- END HEADER -->
  <!-- CONTENT -->

  <script type="text/javascript" src="assets/webrtc-adapter-latest.js"></script>

  <div role="main" class="ui-content" data-dialog="true">


    <!--     quagga html     -->
    <div id="bc_quagga">
        <div id="barcodeviewport" class="viewport">
        </div>
        <!-- basic information displayed in any case -->
        <span>
          scan a <b>barcode</b> (EAN accepted).<br>
        </span>
        <span class="mediumfont">
        we recommend to use a USB-Barcode scanner if you have access to one.<br>
        </span>
        <span class="mediumfont">(QR codes are atm available only on Android Chrome or via phonegap)</span>
    </div>
    <!-- <<< END quagga html -->

    <!--       zxing js html    -->
    <div id="bc_zxing">
      <video id="zxingvideo"
          width="100%"
          style="border: 1px solid gray"
      ></video>

      <div id="sourceSelectPanel" style="display: block;">
        <label for="sourceSelect">Change video source:</label>
        <select id="sourceSelect" style="max-width:400px">
        <!--<option value="2d9ba30ba9b3f3a7a2f2492c8e5ea7bd58f87109e658a528ea6b6040a4ba18dc">FaceTime HD Camera</option>-->
        </select>
      </div>
      <span>
        scan a <b>barcode</b> (EAN accepted)<br> or a <b>QR</b> code.<br>
      </span>
      <span class="mediumfont">
        we recommend to use a USB-Barcode scanner if you have access to one.<br>
      </span>

    </div>
    <!-- <<< END zxing js html -->
    <button id="scan_cancel">cancel scan</button>
  </div>

  <!-- END CONTENT -->

</div>

<script>

/*
the barcode page for the dingsda UI utilizes two different barcode reader libraries:

- QuaggaJS (https://serratus.github.io/quaggaJS/) and
- ZXing-js (https://github.com/zxing-js/library)

Quagga is used for all cases in which Zxing-js does not work. At the time of this writing this is
a) the Safari Browser on Desktop b) all iOS devices.

this should change soon for it uses webrtc technology which is only slowly adapted by apple.

- the third option is to use this within a phonegap packeaged "native" application:

if this is the case phonegaps plugin phonegap_barcode_plugin () should be used.
this works on iOS and Android with the exactly same API and would be long term our recommended
approach outside of the browser.

*/

/**
config for all things considered barcode:
*/
let barcode =
{
  api: "zxingjs", // either quagga, zxingjs or phonegap
  targetinput : null // the target input div to be filled after successful read
}

/* EAN DB response handler:
  ATM PROOF OF CONCEPT!!!
  this uses the external file assets/barcodeCheck.js which talks to third party
  APIs to check the barcode scanned. a Event containing extra product infos is
  dispatched after the third party API responded. this is only a proof of concept
  and will be rebuild and externalized into a proper js module later.
  it also only is relevant for phonegap packed version of this app.

  TODO:
  - rename Event
  - swal asking if user wants to search for items EAN (first time)
  - set config variable addItems.fetchItemInfosFromDB to true
  - check on every successful scan if true
  - check on every time RETURN is pressed inside #addItems #other.barcode
  - if false: do nothing.
  - if true: fetch data and fill name
*/
document.addEventListener("newMessage", newMessageHandler, false);

/**
 END EAN DB response handler (proof of concept receiving messages from 3rd party
 APIs via assets/barcodeCheck.js)
*/
function newMessageHandler(e)
{

  console.log(e.detail);

  if (e.detail.id != undefined)
  {
    console.log(e);
    let items = JSON.parse(e.detail.message).items;
    console.log(items);
    alert(JSON.stringify(items[0]));
    $("#addName").val(items[0].title)

  }

}



////////////////////////////////////
/////// ACTUAL BARCODE CODE ////////
////////////////////////////////////

let isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

// if iOS or safari change api to quagga:
if(navigator.userAgent.match(/(iPhone|iPod|iPad)/i) || isSafari)
{
  barcode.api = "quagga";

  if (window.navigator.standalone == true){
    //alert("no barcode reader, sorry")
    console.log("barcode scanner cannot be accessed because ios in standalone. consider phonegap or browser version");
    $(".barcodebtn").hide() // hide all buttons till apple lets us use webrtc in standalone
  }

}
// if browser is firefox, use quagga:
if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {
  barcode.api = "quagga"
}
// if running in phonegap and not as a homepage/in a browser, choose phonegap api:
if ( document.URL.indexOf( 'http://' ) === -1 && document.URL.indexOf( 'https://' ) === -1 ) {
  // running as PhoneGap application, so we want to use phonegap barcode api:
  barcode.api = "phonegap_barcode_plugin"
}


// this happens after some api scanned a barcode successfully:
document.addEventListener("barcodeScanned",function(e){
  console.log(e.detail.barcode);
  //alert(e.detail.barcode)
  // if this is not null or undefined: fill input that this scanner was called for
  if (barcode.targetinput)
  {
    if (barcode.api !== "phonegap_barcode_plugin") // phonegap plugin just returns on its own
    {
      // go back to the last page (will work without reload because jquery uses hash navigation.)
      history.back();
    }
    setTimeout(function(){
          $(barcode.targetinput).val(e.detail.barcode);
          barcode.targetinput = null;
          console.log("changing "+ barcode.targetinput+" to "+e.detail.barcode);

          if (barcode.api.includes("phonegap_barcode_plugin")){
            getUpcitemdb_com(e.detail.barcode)
          }

    },800)

  }

})

$("#scan_cancel").click(function(){
  cancelscan()
})


/**
cancels scan and changes back to last page visited
*/
function cancelscan(){
  if (codeReader)
  {
    codeReader.reset();
  }
  if (codeReaderBC){
      codeReaderBC.reset();
  }
  if (barcode && barcode.api === "quagga"){
    Quagga.stop();
  }
  history.back()
}

/**
the barcode and qr code scanners main function. starts the correct barcode reader
and opens the barcode scanner page
*/
function scan(target=null) {

  barcode.targetinput = target; // this will be checked on "barcodeScanned" event


  switch(barcode.api) { //// CONTINUE HERE!!!!
    case "quagga":
      $.mobile.changePage("#barcode", {
         reloadPage: false
      });
      $("#bc_zxing").hide();
      $("#bc_quagga").show();
      startQuaggaScan(

        {
          aspectRatio: {min: 1, max: 100},
          facingMode: "environment"
        }

      );
      break;
    case "zxingjs":
      $.mobile.changePage("#barcode", {
         reloadPage: false
      });
      $("#bc_zxing").show();
      $("#bc_quagga").hide();
      startZxingJsScan();
      //startQuaggaScan(); // quagga seems better at barcodes so it runs here in the background
      break;
    case "phonegap_barcode_plugin":
        $("#bc_zxing").hide();
        $("#bc_quagga").hide();
        //alert("sorry. dingsdas phonegap version does not have a barcode/qr code plugin yet")
        startPhoneGapScan();
        break;
    default:

  }
}

/**
dispatches Event "barcodeScanned" after successful scan. This is used to unify the different
barcode reader APIs provided by different libraries etc.
*/
function dispatchBarcodeEvent(barcode){
  let bc_event = new CustomEvent(
    "barcodeScanned",
    {
      detail: {
        barcode: barcode,
        time: new Date(),
      },
      bubbles: true,
      cancelable: true
    }
  );
  document.dispatchEvent(bc_event);
}


</script>


<script type="text/javascript">

///////////////////////////////////////////////////////////////////////////////
/////// PHONEGAP CORDOVA Implementation (should work on iOS & Android) ////////
///////////////////////////////////////////////////////////////////////////////

function startPhoneGapScan(){

  cordova.plugins.barcodeScanner.scan(
      function (result) {
          dispatchBarcodeEvent(result.text);
          /*alert("We got a barcode\n" +
                "Result: " + result.text + "\n" +
                "Format: " + result.format + "\n" +
                "Cancelled: " + result.cancelled);*/
      },
      function (error) {
          alert("Scanning failed: " + error);
      },
      {
          preferFrontCamera : false, // iOS and Android
          showFlipCameraButton : true, // iOS and Android
          showTorchButton : true, // iOS and Android
          //torchOn: true, // Android, launch with the torch switched on (if available)
          //saveHistory: true, // Android, save scan history (default false)
          prompt : "Place a barcode inside the scan area", // Android
          resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
          formats : "QR_CODE,EAN", // default: all but PDF_417 and RSS_EXPANDED
          orientation : "portrait", // Android only (portrait|landscape), default unset so it rotates with the device
          disableAnimations : true, // iOS
          disableSuccessBeep: false // iOS and Android
      }
   );

}


</script>

<script>


///////////////////////////////////////////////////////////////////////////////
/////// ZXING-JS / TS Implementation ( works atm only on Android ) ////////////
///////////////////////////////////////////////////////////////////////////////


//window.addEventListener('load', function () {
    let selectedDeviceId;

    let codeReader = new ZXing.BrowserQRCodeReader()
    let codeReaderBC = new ZXing.BrowserBarcodeReader()
    //const codeReaderBC = new ZXing.BrowserCodeReader()


    console.log('ZXing code reader initialized')

    codeReaderBC.getVideoInputDevices()
        .then((videoInputDevices) => {
          console.log("VideoInputDevices:");
          console.log(videoInputDevices);
            const sourceSelect = document.getElementById('sourceSelect')
            selectedDeviceId = videoInputDevices[0].deviceId
            console.log(selectedDeviceId);
            if (videoInputDevices.length >= 1) {
                videoInputDevices.forEach((element) => {
                    const sourceOption = document.createElement('option')
                    sourceOption.text = element.label
                    sourceOption.value = element.deviceId
                    sourceSelect.appendChild(sourceOption)
                })

                sourceSelect.onchange = () => {
                    selectedDeviceId = sourceSelect.value;
                    cancelscan()
                    //scan(barcode.targetinput)
                  //  startZxingJsScan()
                };


                const sourceSelectPanel = document.getElementById('sourceSelectPanel')
                sourceSelectPanel.style.display = 'block'
            }
        })
        .catch((err) => {
            console.error(err)
        })

        codeReader.getVideoInputDevices()
            .then((videoInputDevices) => {
              console.log("VideoInputDevices:");
              console.log(videoInputDevices);
                let sourceSelect = document.getElementById('sourceSelect')
                selectedDeviceId = videoInputDevices[0].deviceId
                console.log(selectedDeviceId)
            })
            .catch((err) => {
                console.error(err)
            })

//})


function startZxingJsScan(){
  codeReader.reset();
  codeReaderBC.reset();

  let promise1 = codeReaderBC.decodeFromInputVideoDevice(selectedDeviceId, 'zxingvideo')
  let promise2 = codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'zxingvideo')

  Promise.race([promise1, promise2]).then(function(value) {
    console.log(value);
    dispatchBarcodeEvent(value)
    codeReader.reset();
    codeReaderBC.reset();
    Quagga.stop(); // atm because Quagga runs parallel
    // Both resolve, but promise2 is faster
  }).catch((err) => {
      console.error(err)
      // document.getElementById('result').textContent = err
  })

}

///////////////////////////////////////////////////////////////////////////////
/////// <<< END ZXING-JS / TS Implementation ( works atm only on Android ) ////
///////////////////////////////////////////////////////////////////////////////
</script>


<script type="text/javascript" src="assets/quagga.min.js"></script>

<script>

///////////////////////////////////////////////////////////////////////////////
/////// QUAGGA JS Implementation (works best with iOS and okay in some Android)
///////////////////////////////////////////////////////////////////////////////


// to do: exports module stuff
// to do: check config or mobile type if rather starting of barcode scanner
//        app might be appropriate via appname:// thing like with zxing://

function startQuaggaScan(constraints=
    {
      width: {min: 360, max: 1080 /*w*/},
      height: {min: 240, max: window.innerHeight},
      aspectRatio: {min: 1, max: 100},
      facingMode: "environment"
    }
  )
{
  let w = window.innerWidth;
  let h = window.innerHeight;

  Quagga.init({
      inputStream : {
        name : "Live",
        type : "LiveStream",
        target: document.querySelector('#barcodeviewport'),
        constraints: constraints,
        //singleChannel: true
      },
      locator: {
      				patchSize: "medium",
      				halfSample: true
      			},
      numOfWorkers: (navigator.hardwareConcurrency ? navigator.hardwareConcurrency : 4),
      decoder: {
      				"readers":[
      					{"format":"ean_reader","config":{}},
                {"format":"upc_reader","config":{}}
      				]
      			},
      locate: true
    }, function(err) {
        if (err) {
            console.log(err);
            return
        }
        console.log("Barcode Quagga Initialization finished. Ready to start");
        Quagga.start();
    });
}


Quagga.lastResults = [];

Quagga.onDetected(function(result){
  //console.log(result.codeResult.code);
/*
 count and compare result.codeResult.code and if 10 of the same codes
are detected, call Quagga.stop() and return the codeResult including code and
format for further processing (e.g. putting it into Forms)
*/
  if (Quagga.lastResults.length < 4)
  {
    Quagga.lastResults.push(result.codeResult.code);
  }
  else
  {
    let nums = {};
    Quagga.lastResults.forEach(function(x) { nums[x] = (nums[x] || 0) + 1; });
    //console.log(nums);
    let sorted = Object.keys(nums)
      .sort(function(x,y){return nums[x]-nums[y]})
    let barcode = sorted[sorted.length-1] // THIS IS THE BARCODE TO BE RETURNED!
    console.log(barcode);
    dispatchBarcodeEvent(barcode);
    codeReader.reset();
    codeReaderBC.reset();
    Quagga.stop();

    Quagga.lastResults = []; // empty lastResults again
  }

})

Quagga.onProcessed(function(result) {
        var drawingCtx = Quagga.canvas.ctx.overlay,
            drawingCanvas = Quagga.canvas.dom.overlay;

        if (result) {
            if (result.boxes) {
                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                result.boxes.filter(function (box) {
                    return box !== result.box;
                }).forEach(function (box) {
                    Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                });
            }

            if (result.box) {
                Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
            }

            if (result.codeResult && result.codeResult.code) {
                Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
            }
        }
    });

function stopBarcode()
{
  Quagga.stop();
}

</script>


  </body>


  <script>
  // BASE JAVASCRIPT HERE
  const API_BASE_URL = "https://dingsda.org:3000/api/v1/";
  const UI_URL = "https://dingsda.org/two/";

  let glb_username = undefined;

  if (glb_username === undefined)
  {
    login();
  }

  let base = {
    hashhistory:[]
  }

  /*
  track all hash changes (page changes)
  */
  window.addEventListener("hashchange", function(){
    base.hashhistory.unshift(window.location.hash);
  }, false);

  $("#fliplocation").parent().click(function(e){
    if ($("#fliplocation").prop("checked"))
    {
      $(".locationContainer").hide();
      $("#insideOfContainer").show();
    }
    else
    {
      $(".locationContainer").show();
      $("#insideOfContainer").hide();
    }
  })


//document.getElementById("test").onblur=message;
$("input").blur(function(){
  $(document).scrollTop($(document).scrollTop() + 1);
})

///////////// METHODS ///////////////

function login (){

    $.ajax({
      type: "GET",
      url: API_BASE_URL,
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      success: function(res){
        console.log(res);
        if (res.username)
        {
          glb_username = res.username;
          console.log("you are logged in already as "+ glb_username);
          swal({html:"logged in as <br><b>"+ glb_username+"</b>",
          toast:true, timer:1200,showConfirmButton:false, position:"center",
          customClass:"whiteletters"})
          fetchConfig();

          collection.searchQuery = {_id:""};
          collection.searchDB = glb_username;
          /*searchDB(collection.searchDB,collection.searchquery,function(inp){
              collection.searchhistory.unshift(inp.docs);
          });*/


          //searchAndShow(0,0,0,console.log,glb_username);
/* // commented out after new search with pagination
          searchAndDoStepsInBetweenPages(collection.searchDB,collection.searchquery,
            (r)=>{ // callback each loop
                //drawItemCards(r.docs)
            },
            (r)=>{  // callback end
              setNewCollectionSearchHistory(r);
              //callback(r.docs);
            }
          )
*/
          $.mobile.pageContainer.pagecontainer("change", "#landing",
                     {allowSamePageTransition:true});

         setTimeout(function(){
           updateItemBatch();
           updateNotificationsBatch()
         },800)

          //fetchConfig();
        }
      },
      error: function(err){
        console.log(err);
        logout();
        loginPopUp();
      },
      contentType:"application/json"
    });

}

  // login pop up

  function loginPopUp(param={customClass:'animated jello', extra:""})
  {
    let {value: formValues} = swal({
    title: 'login',
    html:
      'log into your dingsda account<br>'+
      '<input id="swal-input1" class="swal2-input" placeholder="username">' +
      '<input id="swal-input2" class="swal2-input" placeholder="password" type="password">'+
      param.extra +
      '<br>don\'t have an account yet? <span class="registerlink">REGISTER!</span>',
    focusConfirm: true,
    allowEscapeKey: false,
    allowOutsideClick: false,
    animation: true,
    showLoaderOnConfirm: true,
    customClass: 'animated shake',
    preConfirm: () => {

      let username = document.getElementById('swal-input1').value;
      let pw = document.getElementById('swal-input2').value;

      $.ajax({
        type: "GET",
        url: API_BASE_URL,
        data: { "name":username,"password":pw },
        xhrFields: { withCredentials: true }, // to make AuthCookie ok
        success: function(res)
          {
            console.log("successfully logged in as "+username);
            glb_username = username;
            swal({html:"logged in as <br><b>"+ glb_username+"</b>",
            toast:true, timer:1200,showConfirmButton:false, position:"center",
            customClass:"whiteletters"})
            updateItemBatch();
            fetchConfig();

            collection.searchQuery = {_id:""};
            collection.searchDB = glb_username;
            /*searchDB(collection.searchDB,collection.searchquery,function(inp){
                collection.searchhistory.unshift(inp);
            });*/
            searchAndDoStepsInBetweenPages(collection.searchDB,collection.searchquery,
              (r)=>{ // callback each loop
                  //drawItemCards(r.docs)
              },
              (r)=>{  // callback end
                setNewCollectionSearchHistory(r);
                //callback(r.docs);
              }
            )

            $.mobile.pageContainer.pagecontainer("change", "#landing",
                       {allowSamePageTransition:true});
            //fetchConfig();
          },
        error: function(err){
          console.log(err);
          logout();
          loginPopUp({extra:"<br><span class='err'>you don't exist! Try again</span><br>"});
        },
        contentType:"application/json"
      });
    }
  })

  $(".registerlink").click(function(){
    console.log("register!");
    logout();
    registerPopUp()
  });

  }


  function showToast(msg="",time){
    swal({html:""+msg,
    toast:true, timer:time,showConfirmButton:false, position:"center",
    customClass:"whiteletters"})
  }

  function updateNotificationsBatch(){
    countNotificationsInDB(function(res){
      $(".notifications_icon").addClass("anim_heartbeat");
      setTimeout(function(){
        $(".notifications_badge").html(res);
        $(".notifications_icon").removeClass("anim_heartbeat");
        $(".notifications_badge").addClass("anim_hop");
        setTimeout(function(){$(".notifications_badge").removeClass("anim_hop")},650);
      },300);
    })
  }

  function getPicAttachment(thingid,callback=console.log,err=console.log)
  {

    if (!thingid.startsWith("http")){
        thingid = API_BASE_URL+glb_username+"/"+thingid;
      }

    console.log("fetching single item attachment: "+thingid);
    // get item json from DB
    $.ajax({
      type: "GET",
      url: thingid+"/pic_small.jpg",
      success: callback,
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      error: err
      ,contentType:"application/json"
    });

  }


  function countNotificationsInDB(callback=console.log){

    console.log("fetching notifications from database");

    getNotificationsFlat(function(notifications){
      console.log("notifications infos:");
      console.log(notifications);
        // get number of total notifications (items 2nd step down the object tree:)
        let length = notifications.length;
        //console.log(length);
        callback(length);
      })

  }

  function getObjectLength(obj){
   return Object.keys(obj).length
  }

</script>



</html>
