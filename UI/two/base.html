<!DOCTYPE html>
<html lang="en">
  <!-- fdff -->
  {{>head}}

  <body class="ui-mobile-viewport ui-overlay-a">

     <img id="loadingGif" src="assets/images/ajax-loader.gif" alt="ladeanimation"></img>

    {{>landing}}

    {{>maps}}

    {{>config}}

    {{>notifications}}

    {{>collection}}

    {{>itemDetails}}

    {{>addNew}}

    {{>move}}

    {{>handover}}

    {{>borrow}}

    {{>search}}

  </body>



  <script>
  // BASE JAVASCRIPT HERE
  const API_BASE_URL = "https://dingsda.org:3000/api/v1/";
  const UI_URL = "https://dingsda.org/two/";

  let glb_username = undefined;

  if (glb_username === undefined)
  {
    login();
  }

  $("#fliplocation").parent().click(function(e){
    if ($("#fliplocation").prop("checked"))
    {
      $(".locationContainer").hide();
      $("#insideOfContainer").show();
    }
    else
    {
      $(".locationContainer").show();
      $("#insideOfContainer").hide();
    }
  })



///////////// METHODS ///////////////

function login (){

    $.ajax({
      type: "GET",
      url: API_BASE_URL,
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      success: function(res){
        console.log(res);
        if (res.username)
        {
          glb_username = res.username;
          console.log("you are logged in already as "+ glb_username);
          swal({html:"logged in as <br><b>"+ glb_username+"</b>",
          toast:true, timer:1200,showConfirmButton:false, position:"center",
          customClass:"whiteletters"})
          fetchConfig();

          collection.searchQuery = {_id:""};
          collection.searchDB = glb_username;
          /*searchDB(collection.searchDB,collection.searchquery,function(inp){
              collection.searchhistory.unshift(inp.docs);
          });*/
          searchAndDoStepsInBetweenPages(collection.searchDB,collection.searchquery,
            (r)=>{ // callback each loop
                //drawItemCards(r.docs)
            },
            (r)=>{  // callback end
              setNewCollectionSearchHistory(r);
              //callback(r.docs);
            }
          )

          $.mobile.pageContainer.pagecontainer("change", "#landing",
                     {allowSamePageTransition:true});

         setTimeout(function(){
           updateItemBatch();
           updateNotificationsBatch()
         },800)
 
          //fetchConfig();
        }
      },
      error: function(err){
        console.log(err);
        logout();
        loginPopUp();
      },
      contentType:"application/json"
    });

}

  // login pop up

  function loginPopUp(param={customClass:'animated jello', extra:""})
  {
    let {value: formValues} = swal({
    title: 'login',
    html:
      'log into your dingsder account<br>'+
      '<input id="swal-input1" class="swal2-input" placeholder="username">' +
      '<input id="swal-input2" class="swal2-input" placeholder="password" type="password">'+
      param.extra +
      '<br>don\'t have an account yet? <span class="registerlink">REGISTER!</span>',
    focusConfirm: true,
    allowEscapeKey: false,
    allowOutsideClick: false,
    animation: true,
    showLoaderOnConfirm: true,
    customClass: 'animated shake',
    preConfirm: () => {

      let username = document.getElementById('swal-input1').value;
      let pw = document.getElementById('swal-input2').value;

      $.ajax({
        type: "GET",
        url: API_BASE_URL,
        data: { "name":username,"password":pw },
        xhrFields: { withCredentials: true }, // to make AuthCookie ok
        success: function(res)
          {
            console.log("successfully logged in as "+username);
            glb_username = username;
            swal({html:"logged in as <br><b>"+ glb_username+"</b>",
            toast:true, timer:1200,showConfirmButton:false, position:"center",
            customClass:"whiteletters"})
            updateItemBatch();
            fetchConfig();

            collection.searchQuery = {_id:""};
            collection.searchDB = glb_username;
            /*searchDB(collection.searchDB,collection.searchquery,function(inp){
                collection.searchhistory.unshift(inp);
            });*/
            searchAndDoStepsInBetweenPages(collection.searchDB,collection.searchquery,
              (r)=>{ // callback each loop
                  //drawItemCards(r.docs)
              },
              (r)=>{  // callback end
                setNewCollectionSearchHistory(r);
                //callback(r.docs);
              }
            )

            $.mobile.pageContainer.pagecontainer("change", "#landing",
                       {allowSamePageTransition:true});
            //fetchConfig();
          },
        error: function(err){
          console.log(err);
          logout();
          loginPopUp({extra:"<br><span class='err'>you don't exist! Try again</span><br>"});
        },
        contentType:"application/json"
      });
    }
  })

  $(".registerlink").click(function(){
    console.log("register!");
    logout();
    registerPopUp()
  });

  }


  function getPicAttachment(thingid,callback=console.log,err=console.log)
  {

    if (!thingid.startsWith("http")){
        thingid = API_BASE_URL+glb_username+"/"+thingid;
      }

    console.log("fetching single item attachment: "+thingid);
    // get item json from DB
    $.ajax({
      type: "GET",
      url: thingid+"/pic_small.jpg",
      success: callback,
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      error: err
      ,contentType:"application/json"
    });

  }

  function showToast(msg="",time){
    swal({html:""+msg,
    toast:true, timer:time,showConfirmButton:false, position:"center",
    customClass:"whiteletters"})
  }

  function updateNotificationsBatch(){
    countNotificationsInDB(function(res){
      $(".notifications_icon").addClass("anim_heartbeat");
      setTimeout(function(){
        $(".notifications_badge").html(res);
        $(".notifications_icon").removeClass("anim_heartbeat");
        $(".notifications_badge").addClass("anim_hop");
        setTimeout(function(){$(".notifications_badge").removeClass("anim_hop")},650);
      },300);
    })
  }


  function countNotificationsInDB(callback=console.log){

    console.log("fetching notifications from database");

    getNotificationsFlat(function(notifications){
      console.log("notifications infos:");
      console.log(notifications);
        // get number of total notifications (items 2nd step down the object tree:)
        let length = notifications.length;
        //console.log(length);
        callback(length);
      })
  /*
    $.ajax({
      type: "GET",
      url: API_BASE_URL+glb_username+"/_all_docs",
      success: function(notifications){
        // get number of total notifications (items 2nd step down the object tree:)
        let length = notifications.total_rows;
        //console.log(length);
        callback(length);
      },
      xhrFields: { withCredentials: true }, // to make AuthCookie ok
      error: console.log
      ,contentType:"application/json"
    });
*/
    /*
    getSingleItem("&notifications",function(notifications){
      // get number of total notifications (items 2nd step down the object tree:)
      let length = 0;
      for (let i = 0; i < getObjectLength(notifications.pending); i++)
      {
        let obj = notifications.pending[Object.keys(notifications.pending)[i]]
        length += getObjectLength(obj);
        //console.log(obj);
      }
      //console.log(length);
      callback(length);

    })
    */

  }

  function getObjectLength(obj){
   return Object.keys(obj).length
  }


  </script>


</html>
